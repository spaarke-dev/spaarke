# Task 08.1: Clean Up Deprecated IGraphClientFactory Methods

**Task ID**: `08.1-Cleanup-Deprecated-Methods`
**Estimated Time**: 30-45 minutes
**Status**: Not Started (Deferred)
**Dependencies**: 05-TASK-FileAccessEndpoints-Refactor, 08-TASK-Program-DI-Update
**Priority**: Low (Technical Debt Cleanup)

---

## üìã Prompt

Remove deprecated `CreateAppOnlyClient()` and `CreateOnBehalfOfClientAsync(string)` methods from `IGraphClientFactory` and `GraphClientFactory` after migrating all call sites to use the new `ForApp()` and `ForUserAsync(HttpContext, CancellationToken)` methods.

---

## ‚ö†Ô∏è Why This Task Was Deferred

During Tasks 03-04, we added new methods (`ForUserAsync`, `ForApp`) while keeping the old methods marked as `[Obsolete]` for backward compatibility. This task was intentionally deferred to:

1. **Maintain focus** - Task 05 (FileAccessEndpoints refactor) is the critical fix for "Access denied" errors
2. **Reduce risk** - Avoid changing 11 call sites across 3 files during the main implementation
3. **Enable gradual migration** - Other services (UploadSessionManager, DriveItemOperations) work correctly with old methods

**Decision**: Complete core OBO refactor first, then clean up deprecated methods as separate task.

---

## ‚úÖ Todos

- [ ] Read and understand all 11 call sites
- [ ] Update UploadSessionManager.cs (3 call sites)
- [ ] Update DriveItemOperations.cs (7 call sites)
- [ ] Remove Program.cs GraphServiceClient DI registration (if not already done in Task 08)
- [ ] Remove `[Obsolete]` methods from IGraphClientFactory interface
- [ ] Remove deprecated method implementations from GraphClientFactory
- [ ] Build and verify no compilation errors
- [ ] Run tests to ensure no behavioral changes
- [ ] Build succeeds with 0 SDAP001/SDAP002 warnings

---

## üìö Required Knowledge

### Current Deprecated Methods (Tasks 03-04)

**In IGraphClientFactory.cs**:
```csharp
// DEPRECATED - Will be removed in this task
[Obsolete("Use ForApp() instead", DiagnosticId = "SDAP001")]
GraphServiceClient CreateAppOnlyClient();

[Obsolete("Use ForUserAsync(HttpContext, CancellationToken) instead", DiagnosticId = "SDAP002")]
Task<GraphServiceClient> CreateOnBehalfOfClientAsync(string userAccessToken);
```

**New Methods** (keep these):
```csharp
Task<GraphServiceClient> ForUserAsync(HttpContext ctx, CancellationToken ct = default);
GraphServiceClient ForApp();
```

### Call Sites to Update (11 total)

From build warnings during Task 04:

#### SDAP001: CreateAppOnlyClient() ‚Üí ForApp()
1. **UploadSessionManager.cs line 104**
2. **DriveItemOperations.cs line 163**
3. **DriveItemOperations.cs line 207**
4. **DriveItemOperations.cs line 679**
5. **Program.cs line 272** (GraphServiceClient DI - should be removed in Task 08)

#### SDAP002: CreateOnBehalfOfClientAsync(string) ‚Üí ForUserAsync(HttpContext, ct)
1. **UploadSessionManager.cs line 238**
2. **UploadSessionManager.cs line 325**
3. **DriveItemOperations.cs line 277**
4. **DriveItemOperations.cs line 391**
5. **DriveItemOperations.cs line 542**
6. **DriveItemOperations.cs line 627**

---

## üìÇ Related Files

**Files to Modify**:
- [src/api/Spe.Bff.Api/Infrastructure/Graph/UploadSessionManager.cs](../../../src/api/Spe.Bff.Api/Infrastructure/Graph/UploadSessionManager.cs) - 3 call sites
- [src/api/Spe.Bff.Api/Infrastructure/Graph/DriveItemOperations.cs](../../../src/api/Spe.Bff.Api/Infrastructure/Graph/DriveItemOperations.cs) - 7 call sites
- [src/api/Spe.Bff.Api/Infrastructure/Graph/IGraphClientFactory.cs](../../../src/api/Spe.Bff.Api/Infrastructure/Graph/IGraphClientFactory.cs) - Remove deprecated methods
- [src/api/Spe.Bff.Api/Infrastructure/Graph/GraphClientFactory.cs](../../../src/api/Spe.Bff.Api/Infrastructure/Graph/GraphClientFactory.cs) - Remove implementations
- [src/api/Spe.Bff.Api/Program.cs](../../../src/api/Spe.Bff.Api/Program.cs) - 1 call site (may already be removed in Task 08)

---

## üéØ Migration Patterns

### Pattern 1: CreateAppOnlyClient() ‚Üí ForApp()

**Before**:
```csharp
var graphClient = _graphClientFactory.CreateAppOnlyClient();
```

**After**:
```csharp
var graphClient = _graphClientFactory.ForApp();
```

**Simple 1:1 replacement** - No parameters, no async, same return type.

---

### Pattern 2: CreateOnBehalfOfClientAsync(string) ‚Üí ForUserAsync(HttpContext, ct)

This is more complex because the old method accepts a `string userAccessToken`, but the new method needs `HttpContext`.

#### Scenario A: HttpContext Already Available

**Before**:
```csharp
// Method signature has HttpContext parameter
public async Task<DriveItem> DownloadFileAsync(
    string userAccessToken,
    string containerId,
    string itemId,
    HttpContext ctx,  // Already have this!
    CancellationToken ct)
{
    var graphClient = await _graphClientFactory.CreateOnBehalfOfClientAsync(userAccessToken);
    // ...
}
```

**After**:
```csharp
public async Task<DriveItem> DownloadFileAsync(
    string containerId,  // Remove userAccessToken parameter
    string itemId,
    HttpContext ctx,
    CancellationToken ct)
{
    var graphClient = await _graphClientFactory.ForUserAsync(ctx, ct);  // Use ctx instead
    // ...
}
```

**Changes**:
1. Remove `string userAccessToken` parameter from method signature
2. Use `ForUserAsync(ctx, ct)` instead of `CreateOnBehalfOfClientAsync(userAccessToken)`
3. Update all callers to not pass the token

---

#### Scenario B: HttpContext NOT Available (Rare)

If the method doesn't have HttpContext parameter, you need to:

**Option 1**: Add HttpContext parameter (preferred)
```csharp
// Add HttpContext to method signature
public async Task<DriveItem> SomeMethod(
    string containerId,
    HttpContext ctx,  // Add this
    CancellationToken ct)
{
    var graphClient = await _graphClientFactory.ForUserAsync(ctx, ct);
}
```

**Option 2**: Keep using deprecated method (if HttpContext truly unavailable)
- This should be rare - most service methods are called from endpoints that have HttpContext
- If unavoidable, document why and revisit later

---

## üîç Example: UploadSessionManager.cs

Let's walk through one file as an example.

### Current Code (with deprecated methods)

```csharp
// Line 104 - SDAP001
var graphClient = _graphClientFactory.CreateAppOnlyClient();

// Line 238 - SDAP002
var graphClient = await _graphClientFactory.CreateOnBehalfOfClientAsync(userAccessToken);

// Line 325 - SDAP002
var graphClient = await _graphClientFactory.CreateOnBehalfOfClientAsync(userAccessToken);
```

### Investigation Needed

1. **Check method signatures** - Do these methods have `HttpContext` parameter?
2. **Check callers** - Where is `userAccessToken` coming from? Can we get HttpContext from caller instead?
3. **Decide migration approach** - Add HttpContext parameter or keep token parameter?

### Likely Refactor (needs verification)

If methods are called from endpoints (which they likely are):

```csharp
// Before:
public async Task StartUploadSessionAsync(
    string userAccessToken,
    string containerId,
    CancellationToken ct)
{
    var graphClient = await _graphClientFactory.CreateOnBehalfOfClientAsync(userAccessToken);
}

// After:
public async Task StartUploadSessionAsync(
    HttpContext ctx,
    string containerId,
    CancellationToken ct)
{
    var graphClient = await _graphClientFactory.ForUserAsync(ctx, ct);
}
```

---

## üöÄ Implementation Steps

### Step 1: Understand Current Usage

For each file, read the methods using deprecated calls:

```bash
# Find all deprecated method calls
cd c:/code_files/spaarke
grep -n "CreateAppOnlyClient\|CreateOnBehalfOfClientAsync" src/api/Spe.Bff.Api/Infrastructure/Graph/*.cs
```

### Step 2: Update UploadSessionManager.cs

1. Read the file and identify the 3 call sites
2. Check method signatures - do they have HttpContext?
3. Update method signatures to accept HttpContext if needed
4. Replace deprecated calls with new methods
5. Update all callers to pass HttpContext instead of token

### Step 3: Update DriveItemOperations.cs

Same process as Step 2, but with 7 call sites.

### Step 4: Remove Deprecated Methods

**IGraphClientFactory.cs**:
```csharp
// DELETE these methods (lines 45-57)
[Obsolete("Use ForApp() instead", DiagnosticId = "SDAP001")]
GraphServiceClient CreateAppOnlyClient();

[Obsolete("Use ForUserAsync(HttpContext, CancellationToken) instead", DiagnosticId = "SDAP002")]
Task<GraphServiceClient> CreateOnBehalfOfClientAsync(string userAccessToken);
```

**GraphClientFactory.cs**:
```csharp
// DELETE these implementations
public GraphServiceClient CreateAppOnlyClient() { ... }
public async Task<GraphServiceClient> CreateOnBehalfOfClientAsync(string userAccessToken) { ... }
```

**Keep the helper method** `CreateGraphClientFromToken(string accessToken)` - it's used by `ForUserAsync`.

---

## ‚úÖ Acceptance Criteria

### Build Success
- [ ] Project builds without errors
- [ ] Zero SDAP001 warnings (no CreateAppOnlyClient calls)
- [ ] Zero SDAP002 warnings (no CreateOnBehalfOfClientAsync calls)

### Code Quality
- [ ] All 11 call sites updated to use new methods
- [ ] Method signatures updated to pass HttpContext instead of string token
- [ ] Deprecated methods removed from interface
- [ ] Deprecated implementations removed from factory

### Testing
- [ ] Run existing tests - all pass
- [ ] Manually test file upload/download operations
- [ ] Verify OBO flow still works (check Azure logs)

### Verification Commands
```bash
# Build
dotnet build src/api/Spe.Bff.Api/Spe.Bff.Api.csproj --configuration Release

# Should see: 0 Error(s), and NO SDAP001/SDAP002 warnings

# Verify no deprecated method references
grep -r "CreateAppOnlyClient\|CreateOnBehalfOfClientAsync" src/api/Spe.Bff.Api --include="*.cs"
# Should only find references in comments or documentation
```

---

## üìù Notes

### Why This Cleanup Matters

1. **Code clarity** - Developers know there's only one way to create Graph clients
2. **Less maintenance** - No need to maintain two parallel implementations
3. **Prevents misuse** - Can't accidentally use app-only when OBO is needed

### Risks

1. **Breaking callers** - If UploadSessionManager/DriveItemOperations have external consumers
   - **Mitigation**: These are internal services, not public APIs
2. **Behavioral changes** - If token extraction in ForUserAsync behaves differently
   - **Mitigation**: ForUserAsync uses same TokenHelper that endpoints already use
3. **Missing HttpContext** - Some methods may not have HttpContext available
   - **Mitigation**: Identify these early and decide on approach

---

## üîó Related Tasks

- **Task 03**: Added new interface methods with [Obsolete] on old ones
- **Task 04**: Implemented ForUserAsync and ForApp
- **Task 08**: Removed Program.cs GraphServiceClient DI registration

---

**Previous Task**: [08-TASK-Program-DI-Update.md](./08-TASK-Program-DI-Update.md)
**Next Task**: [09-TASK-Build-Test-Local.md](./09-TASK-Build-Test-Local.md)

---

**Status**: Deferred until after successful Task 05-10 deployment
