<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDAP Container File Listing</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #0078d4;
            margin-bottom: 10px;
        }
        .info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #0078d4;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #323130;
        }
        input, button {
            padding: 10px;
            font-size: 14px;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
        }
        input {
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background-color: #0078d4;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            padding: 10px 20px;
        }
        button:hover {
            background-color: #106ebe;
        }
        button:disabled {
            background-color: #d1d1d1;
            cursor: not-allowed;
        }
        #output {
            margin-top: 30px;
        }
        .error {
            background: #fde7e9;
            color: #a80000;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #a80000;
        }
        .success {
            background: #dff6dd;
            color: #107c10;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #107c10;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #edebe9;
        }
        th {
            background-color: #f3f2f1;
            font-weight: 600;
            color: #323130;
        }
        tr:hover {
            background-color: #f9f9f9;
        }
        code {
            background: #f3f2f1;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .copy-btn {
            background: #edebe9;
            color: #323130;
            border: 1px solid #d1d1d1;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 3px;
            margin-left: 10px;
        }
        .copy-btn:hover {
            background: #e1dfdd;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #605e5c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SDAP Container File Listing</h1>

        <div class="info">
            <strong>Instructions:</strong> This tool will list all files in a SharePoint Embedded container via the SDAP BFF API.
            You'll get the file IDs and URLs needed to populate your Dataverse Document records.
        </div>

        <div class="form-group">
            <label for="apiUrl">SDAP API Base URL:</label>
            <input type="text" id="apiUrl" value="https://spe-api-dev-67e2xz.azurewebsites.net" />
        </div>

        <div class="form-group">
            <label for="driveId">Drive/Container ID:</label>
            <input type="text" id="driveId" value="b!rAta3Ht_zEKl6AqiQObblUhqWZU646tBrEagKKMKiOcv-7Yo7739SKCuM2H-RPAy" />
        </div>

        <div class="form-group">
            <label for="itemId">Parent Item ID (optional - leave empty for root):</label>
            <input type="text" id="itemId" placeholder="Leave empty to list root files" />
        </div>

        <button id="listBtn" onclick="listFiles()">List Files</button>

        <div id="output"></div>
    </div>

    <script>
        async function listFiles() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const driveId = document.getElementById('driveId').value.trim();
            const itemId = document.getElementById('itemId').value.trim();
            const output = document.getElementById('output');
            const btn = document.getElementById('listBtn');

            if (!apiUrl || !driveId) {
                output.innerHTML = '<div class="error">Please provide API URL and Drive/Container ID</div>';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Loading...';
            output.innerHTML = '<div class="loading">Fetching files from SharePoint Embedded...</div>';

            try {
                // Build URL
                let url = `${apiUrl}/api/drives/${encodeURIComponent(driveId)}/children`;
                if (itemId) {
                    url += `?itemId=${encodeURIComponent(itemId)}`;
                }

                console.log('Fetching:', url);

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'include' // Include cookies for authentication
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const files = await response.json();

                if (!files || files.length === 0) {
                    output.innerHTML = '<div class="info">No files found in this container/folder.</div>';
                    return;
                }

                // Display results in table
                let html = `<div class="success">Found ${files.length} file(s)</div>`;
                html += '<table>';
                html += '<thead><tr><th>File Name</th><th>Item ID</th><th>Web URL</th><th>Size</th><th>Modified</th></tr></thead>';
                html += '<tbody>';

                files.forEach(file => {
                    html += '<tr>';
                    html += `<td><strong>${escapeHtml(file.name)}</strong></td>`;
                    html += `<td><code>${escapeHtml(file.id)}</code> <button class="copy-btn" onclick="copyToClipboard('${file.id}')">Copy</button></td>`;
                    html += `<td>${file.webUrl ? `<a href="${file.webUrl}" target="_blank">Open</a>` : '-'}</td>`;
                    html += `<td>${formatBytes(file.size)}</td>`;
                    html += `<td>${new Date(file.lastModifiedDateTime).toLocaleString()}</td>`;
                    html += '</tr>';

                    // Add details row
                    html += '<tr style="background: #f9f9f9; font-size: 12px;">';
                    html += `<td colspan="5">`;
                    html += `<strong>Full Metadata:</strong><br>`;
                    html += `<code style="display: block; white-space: pre-wrap; margin-top: 5px;">${JSON.stringify(file, null, 2)}</code>`;
                    html += `</td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';

                // Add summary for copy-paste
                html += '<div style="margin-top: 30px; background: #f3f2f1; padding: 15px; border-radius: 4px;">';
                html += '<strong>Quick Reference for Dataverse:</strong><br><br>';
                files.forEach(file => {
                    html += `<strong>${escapeHtml(file.name)}</strong><br>`;
                    html += `├ Item ID: <code>${escapeHtml(file.id)}</code> <button class="copy-btn" onclick="copyToClipboard('${file.id}')">Copy</button><br>`;
                    html += `├ Web URL: <code>${escapeHtml(file.webUrl || 'N/A')}</code> <button class="copy-btn" onclick="copyToClipboard('${file.webUrl || ''}')">Copy</button><br>`;
                    html += `├ Size: ${formatBytes(file.size)}<br>`;
                    html += `├ Parent: ${escapeHtml(file.parentId || 'root')}<br>`;
                    html += `└ ETag: ${escapeHtml(file.eTag || 'N/A')}<br><br>`;
                });
                html += '</div>';

                output.innerHTML = html;

            } catch (error) {
                console.error('Error:', error);
                output.innerHTML = `<div class="error"><strong>Error:</strong> ${escapeHtml(error.message)}<br><br>
                    <strong>Troubleshooting:</strong><ul>
                    <li>Ensure you're logged in to the Power Platform environment</li>
                    <li>Check that the SDAP API is running and accessible</li>
                    <li>Verify the container/drive ID is correct</li>
                    <li>Check browser console for CORS errors</li>
                    </ul></div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'List Files';
            }
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function formatBytes(bytes) {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Auto-run on page load
        window.addEventListener('load', () => {
            // Optionally auto-run
            // listFiles();
        });
    </script>
</body>
</html>
