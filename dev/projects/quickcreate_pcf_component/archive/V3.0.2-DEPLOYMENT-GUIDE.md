# Universal Document Upload v3.0.2 - Complete Deployment Guide

## Summary of v3.0.2 Changes

This version fixes the Custom Page parameter passing issue. The expert identified that `Param("data")` returns a **JSON string**, not a record object, requiring parsing before accessing fields.

### What Was Fixed:
1. ‚úÖ **PCF Manifest**: Properties use `usage="input"` (already fixed in previous deployment)
2. ‚úÖ **Web Resource**: Passes parameters under `data: {...}` property
3. ‚úÖ **Version Strings**: All version references updated to 3.0.2
4. ‚úÖ **Custom Page Formula**: Must use `ParseJSON(Param("data"))` to parse JSON string

### Key Insight from Expert:
> "Power Apps delivers `Param("data")` as a JSON string, so treating it like a record (`Param("data").parentEntityName`) throws 'The '.' operator cannot be used on Text values.' Parse the JSON first, then extract fields, and the PCF will hydrate on the next updateView."

---

## üì¶ Deployment Steps

### Step 1: Deploy Web Resource v3.0.2 ‚úÖ DONE

The web resource has been updated to v3.0.2 and already contains the `data` wrapper.

**Manual Deployment (if needed):**
1. Open https://make.powerapps.com
2. Go to **Solutions** ‚Üí **UniversalQuickCreateSolution**
3. Find web resource: **sprk_subgrid_commands.js**
4. Edit and verify lines 306-311 show:
```javascript
data: {
    parentEntityName: params.parentEntityName,
    parentRecordId: params.parentRecordId,
    containerId: params.containerId,
    parentDisplayName: params.parentDisplayName
}
```
5. Save and **Publish All Customizations**

**Verification:**
- Open browser console
- Click "Upload Documents" button
- Should see: `[Spaarke] AddMultipleDocuments: Starting v3.0.2 - CUSTOM PAGE DIALOG`

---

### Step 2: Deploy PCF v3.0.2 ‚úÖ DONE

PCF control has been deployed to Dataverse.

**Verification via Component Library:**
1. Open the Custom Page in Power Apps editor
2. Try to add the UniversalDocumentUpload control
3. Component library should show **version 3.0.2**

---

### Step 3: Update Custom Page Formulas ‚è≥ **YOU NEED TO DO THIS**

This is the **critical fix** based on expert guidance.

#### A. Update App.OnStart

```powerfx
Set(_init, false);
Set(varParentEntityName, Blank());
Set(varParentRecordId, Blank());
Set(varContainerId, Blank());
Set(varParentDisplayName, Blank())
```

#### B. Update Screen.OnVisible (CRITICAL FIX)

**OLD (BROKEN) - Don't use this:**
```powerfx
If(
    Not(_init),
    Set(_init, true);
    Set(_params, Param("data"));
    Set(varParentEntityName, _params.parentEntityName);  // ‚ùå Fails - treats JSON string as record
    ...
)
```

**NEW (CORRECT) - Use this:**
```powerfx
If(
    Not(_init),
    Set(_init, true);
    Set(_dataJson, Param("data"));
    Set(_dataParsed, ParseJSON(_dataJson));
    Set(varParentEntityName, Text(_dataParsed.parentEntityName));
    Set(varParentRecordId, Text(_dataParsed.parentRecordId));
    Set(varContainerId, Text(_dataParsed.containerId));
    Set(varParentDisplayName, Text(_dataParsed.parentDisplayName))
)
```

**Key Changes:**
1. `Param("data")` returns a **JSON string**, not a record
2. Use `ParseJSON()` to convert string ‚Üí untyped object
3. Use `Text()` to extract each field as text
4. Now the dot operator works on the parsed object

#### C. PCF Control Visible Property

```powerfx
And(
    Not(IsBlank(varParentEntityName)),
    Not(IsBlank(varParentRecordId)),
    Not(IsBlank(varContainerId))
)
```

#### D. PCF Control Property Bindings

Make sure these are set:
- **parentEntityName**: `varParentEntityName`
- **parentRecordId**: `varParentRecordId`
- **containerId**: `varContainerId`
- **parentDisplayName**: `varParentDisplayName`
- **sdapApiBaseUrl**: `"https://spe-api-dev-67e2xz.azurewebsites.net/api"`

---

### Step 4: Remove and Re-add PCF Control ‚è≥ **YOU NEED TO DO THIS**

To ensure v3.0.2 loads (not cached v3.0.1):

1. Open Custom Page: **sprk_documentuploaddialog_e52db**
2. **Delete** the UniversalDocumentUpload PCF control
3. **Save** the Custom Page
4. **Close** the Custom Page editor
5. **Reopen** the Custom Page
6. **Add** the UniversalDocumentUpload control from component library
   - Verify it shows **v3.0.2**
7. Configure properties (see Step 3D above)
8. Set Visible property (see Step 3C above)
9. **Save** and **Publish**

---

### Step 5: Test End-to-End ‚è≥ **TEST THIS**

1. **Hard refresh** browser (Ctrl+Shift+R)
2. Open a **Matter** record with a Container ID
3. Click **"Upload Documents"** button on Documents subgrid

**Expected Console Output:**
```
[Spaarke] ========================================
[Spaarke] AddMultipleDocuments: Starting v3.0.2 - CUSTOM PAGE DIALOG
[Spaarke] ========================================
[Spaarke] Opening Custom Page Dialog with parameters: {...}
[Spaarke] Page Input: {
  pageType: 'custom',
  name: 'sprk_documentuploaddialog_e52db',
  data: {
    parentEntityName: 'sprk_matter',
    parentRecordId: '...',
    containerId: 'b!...',
    parentDisplayName: '...'
  }
}

[UniversalDocumentUpload] Initializing PCF control v3.0.2 (USAGE=INPUT + PARAM DATA FIX)
[UniversalDocumentUpload] Waiting for parameters to hydrate {hasEntityName: false, hasRecordId: false, hasContainerId: false}
[UniversalDocumentUpload] Parameters hydrated - initializing async {
  parentEntityName: 'sprk_matter',
  parentRecordId: '...',
  containerId: '...'
}
[UniversalDocumentUpload] Parent context loaded {...}
[UniversalDocumentUpload] Entity configuration found {...}
[UniversalDocumentUpload] Initialization complete
```

**Expected Visual:**
- ‚úÖ Right-side panel opens (640px width)
- ‚úÖ Green version badge: **"‚úì V3.0.2 - USAGE=INPUT - PARAM(DATA)"**
- ‚úÖ Upload form renders with file picker
- ‚úÖ No blank screen
- ‚úÖ No "Missing parameters" error

---

## üîç Troubleshooting

### Issue: Still seeing "v3.0.1" or older version

**Solution:**
- Remove PCF control from Custom Page
- Save and close Custom Page
- Reopen and re-add control
- Verify component library shows v3.0.2

### Issue: Variables still blank in Custom Page

**Solution:**
- Verify Screen.OnVisible uses `ParseJSON(Param("data"))`
- Check browser console for formula errors
- Add debug statement:
```powerfx
If(
    Not(_init),
    Set(_init, true);
    Set(_dataJson, Param("data"));
    Notify("Raw data: " & _dataJson, NotificationType.Information);  // Debug
    Set(_dataParsed, ParseJSON(_dataJson));
    ...
)
```

### Issue: PCF shows "Waiting for parameters" indefinitely

**Root Causes:**
1. Custom Page formulas not parsing JSON correctly
2. Variables not bound to PCF properties
3. PCF Visible property hiding the control

**Solution:**
- Verify all formulas from Step 3
- Check PCF property bindings
- Temporarily set Visible to `true` to see if control appears

---

## ‚úÖ Success Criteria

- [ ] Console shows: `AddMultipleDocuments: Starting v3.0.2`
- [ ] Console shows: `Initializing PCF control v3.0.2`
- [ ] Version badge shows: `V3.0.2 - USAGE=INPUT - PARAM(DATA)`
- [ ] Console shows: `Parameters hydrated - initializing async`
- [ ] Upload form renders with file picker
- [ ] Can select files and see them in list
- [ ] Can upload files successfully
- [ ] Documents appear in subgrid after upload

---

## üìã Files Modified in v3.0.2

1. **[sprk_subgrid_commands.js](C:/code_files/spaarke/sprk_subgrid_commands.js)**
   - Line 9: Version updated to 3.0.2
   - Line 76: Console log shows v3.0.2
   - Line 281: Version comment updated
   - Lines 306-311: Uses `data: {...}` wrapper

2. **[index.ts](C:/code_files/spaarke/src/controls/UniversalQuickCreate/UniversalQuickCreate/index.ts)**
   - Line 20: @version updated to 3.0.2
   - Line 101: Log message shows v3.0.2
   - Line 116: Version badge shows v3.0.2

3. **[ControlManifest.Input.xml](C:/code_files/spaarke/src/controls/UniversalQuickCreate/UniversalQuickCreate/ControlManifest.Input.xml)**
   - Line 7: Version 3.0.2
   - Line 8: Description updated
   - Lines 18-47: All properties use `usage="input"`

---

## üéØ Next Steps After Deployment

Once v3.0.2 is working:

1. Test on all 5 entity types:
   - ‚úÖ sprk_matter
   - ‚è≥ sprk_project
   - ‚è≥ sprk_invoice
   - ‚è≥ account
   - ‚è≥ contact

2. Test edge cases:
   - Record without Container ID
   - Unsupported entity type
   - Network errors during upload
   - Large file uploads
   - Multiple file uploads

3. Monitor for errors in production use

4. Document any issues for future fixes

---

## üìû Support

If issues persist after following this guide:

1. Check browser console for errors
2. Verify all formulas match exactly (copy-paste recommended)
3. Hard refresh browser (Ctrl+Shift+R)
4. Clear browser cache completely
5. Try in incognito/private window

---

**Deployment Date**: 2025-10-21
**Deployed By**: Claude + User
**Environment**: SPAARKE DEV 1
**Status**: PCF and Web Resource deployed ‚úÖ | Custom Page formulas pending ‚è≥
