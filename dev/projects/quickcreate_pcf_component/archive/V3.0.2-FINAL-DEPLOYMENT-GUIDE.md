# V3.0.2 FINAL DEPLOYMENT GUIDE - Custom Page Parameters Fix

## ‚úÖ ROOT CAUSE IDENTIFIED BY EXPERT

**Problem:** "Invalid input to custom page, input needs to be an object"

**Root Cause:** Using `data:` property triggers Dataverse validation against Custom Page declared inputs. Since we haven't declared inputs in the Custom Page UI, validation fails.

**Solution:** Use `parameters:` property instead - this is the officially supported pattern that doesn't require declaring inputs.

---

## üìã What You Need To Do

### Step 1: Upload Web Resource v3.0.2 ‚ö†Ô∏è CRITICAL

The web resource has been updated locally but **NOT deployed to Dataverse yet**.

**Manual Upload Steps:**
1. Go to https://make.powerapps.com
2. Select environment: **SPAARKE DEV 1**
3. Go to **Solutions** ‚Üí **UniversalQuickCreateSolution**
4. Find **sprk_subgrid_commands.js**
5. Click **Edit** or Upload icon
6. Upload file: `C:\code_files\spaarke\sprk_subgrid_commands.js`
7. Click **Save**
8. Click **Publish All Customizations** ‚Üê CRITICAL!

**What Changed:**
```javascript
// OLD (caused error):
const pageInput = {
    pageType: "custom",
    name: "sprk_documentuploaddialog_e52db",
    data: {  // ‚ùå This triggers validation error
        parentEntityName: params.parentEntityName,
        ...
    }
};

// NEW (works):
const pageInput = {
    pageType: "custom",
    name: "sprk_documentuploaddialog_e52db",
    parameters: {  // ‚úÖ Official supported pattern
        parentEntityName: params?.parentEntityName ?? "",
        parentRecordId: (params?.parentRecordId ?? "").replace(/[{}]/g, "").toLowerCase(),
        containerId: params?.containerId ?? "",
        parentDisplayName: params?.parentDisplayName ?? ""
    },
    appId: appId
};
```

---

### Step 2: Update Custom Page Formulas ‚ö†Ô∏è CRITICAL

Since we're now using `parameters:` instead of `data:`, the Custom Page formulas are **MUCH SIMPLER**.

#### A. App.OnStart

```powerfx
Set(_init, false);
Set(varParentEntityName, Blank());
Set(varParentRecordId, Blank());
Set(varContainerId, Blank());
Set(varParentDisplayName, Blank())
```

#### B. Screen.OnVisible (SIMPLIFIED!)

**OLD (ParseJSON approach - NO LONGER NEEDED):**
```powerfx
If(
    Not(_init),
    Set(_init, true);
    Set(_dataJson, Param("data"));
    Set(_dataParsed, ParseJSON(_dataJson));  // ‚ùå Not needed anymore!
    ...
)
```

**NEW (Direct Param() access):**
```powerfx
If(
    Not(_init),
    Set(_init, true);
    Set(varParentEntityName, Param("parentEntityName"));
    Set(varParentRecordId, Param("parentRecordId"));
    Set(varContainerId, Param("containerId"));
    Set(varParentDisplayName, Param("parentDisplayName"))
)
```

**Why This Works:**
- `parameters:` makes each value available as a **top-level parameter**
- Access directly via `Param("parentEntityName")` - no JSON parsing needed!
- No dot operator, no ParseJSON, just simple Param() calls

#### C. PCF Control Visible Property

```powerfx
And(
    Not(IsBlank(varParentEntityName)),
    Not(IsBlank(varParentRecordId)),
    Not(IsBlank(varContainerId))
)
```

#### D. PCF Control Properties

Set these exact values:

| Property | Value |
|----------|-------|
| parentEntityName | `varParentEntityName` |
| parentRecordId | `varParentRecordId` |
| containerId | `varContainerId` |
| parentDisplayName | `varParentDisplayName` |
| sdapApiBaseUrl | `"https://spe-api-dev-67e2xz.azurewebsites.net/api"` |

---

### Step 3: Remove and Re-Add PCF Control (Optional but Recommended)

To ensure v3.0.2 loads cleanly:

1. Open Custom Page: **sprk_documentuploaddialog_e52db**
2. **Delete** UniversalDocumentUpload control
3. **Save** and **Close**
4. **Reopen** Custom Page
5. **Add** UniversalDocumentUpload control (should show v3.0.2)
6. Configure properties (see Step 2D)
7. Set Visible property (see Step 2C)
8. **Save** and **Publish**

---

### Step 4: Test End-to-End

1. **Hard refresh** browser (Ctrl+Shift+R)
2. Open a **Matter** record with Container ID
3. Click **"Upload Documents"** button

**Expected Console Output:**
```
[Spaarke] AddMultipleDocuments: Starting v3.0.2 - CUSTOM PAGE DIALOG
[Spaarke] Page Input: {
  pageType: 'custom',
  name: 'sprk_documentuploaddialog_e52db',
  parameters: {  // ‚úÖ Note: "parameters" not "data"
    parentEntityName: 'sprk_matter',
    parentRecordId: '3a785f76-c773-f011-b4cb-6045bdd8b757',  // ‚úÖ No braces, lowercase
    containerId: 'b!yLRd...',
    parentDisplayName: '345345345345'
  },
  appId: '...'
}

// No more "Invalid page inputs" error! ‚úÖ

[UniversalDocumentUpload] Initializing PCF control v3.0.2 (USAGE=INPUT + PARAM DATA FIX)
[UniversalDocumentUpload] Parameters hydrated - initializing async
[UniversalDocumentUpload] Initialization complete
```

**Expected Visual:**
- ‚úÖ Right-side panel opens (640px width)
- ‚úÖ Green version badge: **"‚úì V3.0.2 - USAGE=INPUT - PARAM(DATA)"**
- ‚úÖ Upload form renders with file picker
- ‚úÖ **NO "Invalid page inputs" error**
- ‚úÖ **NO blank screen**

---

## üîç Key Changes Summary

### 1. Web Resource Change
```diff
- data: {
+ parameters: {
      parentEntityName: params?.parentEntityName ?? "",
-     parentRecordId: params?.parentRecordId ?? "",
+     parentRecordId: (params?.parentRecordId ?? "").replace(/[{}]/g, "").toLowerCase(),
      containerId: params?.containerId ?? "",
      parentDisplayName: params?.parentDisplayName ?? ""
  }
```

### 2. Custom Page Formula Change
```diff
- Set(_dataJson, Param("data"));
- Set(_dataParsed, ParseJSON(_dataJson));
- Set(varParentEntityName, Text(_dataParsed.parentEntityName));
+ Set(varParentEntityName, Param("parentEntityName"));
+ Set(varParentRecordId, Param("parentRecordId"));
+ Set(varContainerId, Param("containerId"));
+ Set(varParentDisplayName, Param("parentDisplayName"))
```

### 3. Why This Fixes Everything

| Issue | Root Cause | Fix |
|-------|------------|-----|
| "Invalid input to custom page" | `data:` triggers Dataverse validation | Use `parameters:` instead |
| "Input needs to be an object" | No declared inputs in Custom Page | `parameters:` doesn't require declarations |
| GUID with braces | Dataverse doesn't clean GUIDs | `.replace(/[{}]/g, "").toLowerCase()` |
| Undefined parameters | No null safety | Use `params?.field ?? ""` |

---

## ‚úÖ Deployment Checklist

- [ ] Upload `sprk_subgrid_commands.js` to Dataverse
- [ ] Publish All Customizations
- [ ] Update App.OnStart formula
- [ ] Update Screen.OnVisible formula (use simple Param() calls)
- [ ] Set PCF Visible property
- [ ] Configure PCF properties (bind to variables)
- [ ] Remove and re-add PCF control (optional)
- [ ] Save and Publish Custom Page
- [ ] Hard refresh browser
- [ ] Test: Click "Upload Documents"
- [ ] Verify: Console shows v3.0.2
- [ ] Verify: No "Invalid page inputs" error
- [ ] Verify: Upload form renders

---

## üéØ Success Criteria

**Console Output:**
‚úÖ `AddMultipleDocuments: Starting v3.0.2`
‚úÖ `pageType: 'custom', parameters: {...}` (not `data`)
‚úÖ `parentRecordId: '3a785f76...'` (no braces, lowercase)
‚úÖ No "Invalid page inputs" error
‚úÖ `Initializing PCF control v3.0.2`
‚úÖ `Parameters hydrated - initializing async`

**Visual:**
‚úÖ Right-side panel opens
‚úÖ Version badge: `V3.0.2 - USAGE=INPUT - PARAM(DATA)`
‚úÖ Upload form with file picker
‚úÖ Can select and upload files

---

## üìû If You Still Get Errors

1. **"Invalid page inputs"** ‚Üí Web resource not uploaded/published
2. **Parameters still blank** ‚Üí Screen.OnVisible formula incorrect
3. **V3.0.0 in console** ‚Üí Web resource not published
4. **V3.0.1 in version badge** ‚Üí PCF control not refreshed (remove/re-add)
5. **Blank screen** ‚Üí Check PCF Visible property and variable bindings

---

**Deployment Date**: 2025-10-21
**Version**: 3.0.2
**Environment**: SPAARKE DEV 1
**Status**: Code ready ‚úÖ | Deployment pending ‚è≥
