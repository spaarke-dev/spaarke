# ENH-003: Flexible Input Model (Unified)

> **Project**: AI Playbook Node Builder R2
> **Status**: Pending
> **Priority**: High
> **Effort**: 3-4 weeks total across all patterns
> **Related**: [design.md](../../projects/ai-playbook-node-builder-r2/design.md)

---

## Problem Statement

Currently, playbooks operate on a **single SPE-stored document**:
- API: `POST /api/ai/execute-playbook-stream { playbookId, documentId }`
- Requires Dataverse `sprk_document` record
- Requires file stored in SharePoint Embedded (SPE)

Users need more flexible input options:
1. Analyze with uploaded **knowledge files** as RAG context
2. **Compare** two documents side-by-side
3. Analyze **consolidated** multiple documents together
4. Analyze **ad-hoc files** not yet stored in SPE

---

## NOT IN SCOPE

> **Complex N:N Batch Processing** - Running the same playbook N times on N documents
> with parallel execution, progress tracking, and result aggregation is explicitly
> OUT OF SCOPE. This would require BatchOrchestrationService, job queuing, and
> significant infrastructure. Instead, we use a simpler "merge and analyze once"
> approach for multi-document scenarios.

---

## Supported Input Patterns

| Pattern | Subject | Knowledge | Use Case |
|---------|---------|-----------|----------|
| **A: Subject + Knowledge** | 1 document (SPE) | User uploads (RAG) | "Analyze lease using our standards" |
| **B: Document Comparison** | 2 documents | Optional | "Compare Vendor A vs Vendor B" |
| **C: Consolidated Analysis** | N documents (merged) | Optional | "Analyze all 5 portfolio leases" |
| **D: Ad-Hoc File** | Uploaded file | Optional | "Quick analysis before storing" |

---

## Pattern A: Subject Document + Knowledge Files (RAG-Enhanced)

**Description**: Analyze one subject document with uploaded knowledge files providing RAG context.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SUBJECT + KNOWLEDGE PATTERN                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   SUBJECT DOCUMENT  â”‚         â”‚      KNOWLEDGE FILES (uploaded)     â”‚   â”‚
â”‚  â”‚   (Required, SPE)   â”‚         â”‚                                     â”‚   â”‚
â”‚  â”‚                     â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  "Analyze THIS"     â”‚         â”‚  â”‚Std  â”‚ â”‚Policyâ”‚ â”‚Priorâ”‚ â”‚Benchâ”‚   â”‚   â”‚
â”‚  â”‚                     â”‚         â”‚  â”‚Termsâ”‚ â”‚Doc  â”‚ â”‚Leaseâ”‚ â”‚marksâ”‚   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  â””â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”˜   â”‚   â”‚
â”‚             â”‚                     â”‚     â”‚      â”‚      â”‚      â”‚       â”‚   â”‚
â”‚             â”‚                     â”‚     â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚             â”‚                     â”‚              â”‚                    â”‚   â”‚
â”‚             â”‚                     â”‚              â–¼                    â”‚   â”‚
â”‚             â”‚                     â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚             â”‚                     â”‚     â”‚   Chunk &     â”‚            â”‚   â”‚
â”‚             â”‚                     â”‚     â”‚   Embed       â”‚            â”‚   â”‚
â”‚             â”‚                     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚             â”‚                     â”‚             â”‚                     â”‚   â”‚
â”‚             â”‚                     â”‚             â–¼                     â”‚   â”‚
â”‚             â”‚                     â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚             â”‚                     â”‚     â”‚  Session      â”‚            â”‚   â”‚
â”‚             â”‚                     â”‚     â”‚  Vector Store â”‚            â”‚   â”‚
â”‚             â”‚                     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚             â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚             â”‚                                   â”‚                        â”‚
â”‚             â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚             â”‚          â”‚                                                 â”‚
â”‚             â–¼          â–¼                                                 â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚      â”‚       PLAYBOOK          â”‚                                        â”‚
â”‚      â”‚                         â”‚                                        â”‚
â”‚      â”‚  Subject: Full text     â”‚                                        â”‚
â”‚      â”‚  Knowledge: RAG query   â”‚ â† "What are standard deposit terms?"   â”‚
â”‚      â”‚           â†’ Retrieved   â”‚ â† Returns relevant chunks              â”‚
â”‚      â”‚             chunks      â”‚                                        â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Benefit**: LLM focuses on subject document while RAG retrieves relevant context from knowledge files. Scales better than merging all text (only relevant chunks retrieved).

**Use Cases**:
- Analyze lease against company standard terms
- Review contract using policy documents as reference
- Compare document against industry benchmarks

---

## Pattern B: Document Comparison

**Description**: Compare two (or more) subject documents side-by-side.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DOCUMENT COMPARISON PATTERN                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚    DOCUMENT A       â”‚         â”‚    DOCUMENT B       â”‚                   â”‚
â”‚  â”‚    (Subject 1)      â”‚         â”‚    (Subject 2)      â”‚                   â”‚
â”‚  â”‚                     â”‚         â”‚                     â”‚                   â”‚
â”‚  â”‚  "Vendor A Lease"   â”‚   VS    â”‚  "Vendor B Lease"   â”‚                   â”‚
â”‚  â”‚                     â”‚         â”‚                     â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚             â”‚                               â”‚                               â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                             â”‚                                               â”‚
â”‚                             â–¼                                               â”‚
â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚             â”‚  Merged Text with Document Labels â”‚                           â”‚
â”‚             â”‚                                   â”‚                           â”‚
â”‚             â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚                           â”‚
â”‚             â”‚  DOCUMENT A: Vendor A Lease       â”‚                           â”‚
â”‚             â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚                           â”‚
â”‚             â”‚  [Full text of Document A]        â”‚                           â”‚
â”‚             â”‚                                   â”‚                           â”‚
â”‚             â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚                           â”‚
â”‚             â”‚  DOCUMENT B: Vendor B Lease       â”‚                           â”‚
â”‚             â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚                           â”‚
â”‚             â”‚  [Full text of Document B]        â”‚                           â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                             â”‚                                               â”‚
â”‚                             â–¼                                               â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚                   â”‚    PLAYBOOK     â”‚  â† Comparison-aware prompts          â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                            â”‚                                                â”‚
â”‚                            â–¼                                                â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚                   â”‚  COMPARISON     â”‚                                      â”‚
â”‚                   â”‚  REPORT         â”‚                                      â”‚
â”‚                   â”‚  - Side by side â”‚                                      â”‚
â”‚                   â”‚  - Differences  â”‚                                      â”‚
â”‚                   â”‚  - Recommenda-  â”‚                                      â”‚
â”‚                   â”‚    tions        â”‚                                      â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Benefit**: LLM sees both documents in full context, can directly compare provisions.

**Use Cases**:
- Compare vendor proposals
- Review lease amendment against original
- Evaluate competing contract options

---

## Pattern C: Consolidated Multi-Document Analysis

**Description**: Analyze multiple documents together as a single consolidated input.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CONSOLIDATED ANALYSIS PATTERN                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚ Doc 1 â”‚  â”‚ Doc 2 â”‚  â”‚ Doc 3 â”‚  â”‚ Doc 4 â”‚  â”‚ Doc 5 â”‚                   â”‚
â”‚   â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜                   â”‚
â”‚       â”‚          â”‚          â”‚          â”‚          â”‚                         â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                             â”‚                                               â”‚
â”‚                             â–¼                                               â”‚
â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚             â”‚     Text Extraction (parallel)    â”‚                           â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                             â”‚                                               â”‚
â”‚                             â–¼                                               â”‚
â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚             â”‚          MERGE TEXT               â”‚                           â”‚
â”‚             â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚                           â”‚
â”‚             â”‚  DOCUMENT 1: Lease_Property_A     â”‚                           â”‚
â”‚             â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚                           â”‚
â”‚             â”‚  [Text...]                        â”‚                           â”‚
â”‚             â”‚                                   â”‚                           â”‚
â”‚             â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚                           â”‚
â”‚             â”‚  DOCUMENT 2: Lease_Property_B     â”‚                           â”‚
â”‚             â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚                           â”‚
â”‚             â”‚  [Text...]                        â”‚                           â”‚
â”‚             â”‚  ... (repeated for each doc)      â”‚                           â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                             â”‚                                               â”‚
â”‚                             â–¼                                               â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚                   â”‚    PLAYBOOK     â”‚  â† Single execution                  â”‚
â”‚                   â”‚   (runs ONCE)   â”‚  â† LLM sees all docs                 â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                            â”‚                                                â”‚
â”‚                            â–¼                                                â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚                   â”‚  CROSS-DOCUMENT â”‚                                      â”‚
â”‚                   â”‚     ANALYSIS    â”‚                                      â”‚
â”‚                   â”‚  - Portfolio    â”‚                                      â”‚
â”‚                   â”‚    summary      â”‚                                      â”‚
â”‚                   â”‚  - Common       â”‚                                      â”‚
â”‚                   â”‚    issues       â”‚                                      â”‚
â”‚                   â”‚  - Totals       â”‚                                      â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Benefit**: Simple implementation (merge + run once), no batch orchestration needed.

**Limitations**:
- Context window limits (~300 pages with GPT-4o 128K)
- Set reasonable max document count (e.g., 10 documents)

**Use Cases**:
- Portfolio analysis (all leases for a property group)
- Due diligence document review
- Compliance audit across document set

---

## Pattern D: Ad-Hoc File Analysis

**Description**: Analyze uploaded files not yet stored in SPE/Dataverse.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       AD-HOC FILE ANALYSIS                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
â”‚        â”‚   Browser   â”‚                                                     â”‚
â”‚        â”‚  File Input â”‚                                                     â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                     â”‚
â”‚               â”‚ Upload                                                      â”‚
â”‚               â–¼                                                             â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚        â”‚     POST /api/ai/analyze               â”‚                         â”‚
â”‚        â”‚     Content-Type: multipart/form-data   â”‚                         â”‚
â”‚        â”‚     - subjectFile: <binary>             â”‚                         â”‚
â”‚        â”‚     - playbookId: "PB-LEASE-001"        â”‚                         â”‚
â”‚        â”‚     - knowledgeFiles: [<binary>, ...]   â”‚  (optional)            â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚               â”‚                                                             â”‚
â”‚               â–¼                                                             â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚        â”‚         BFF API                         â”‚                         â”‚
â”‚        â”‚  1. Store in temp blob (24hr TTL)       â”‚                         â”‚
â”‚        â”‚  2. Extract text                        â”‚                         â”‚
â”‚        â”‚  3. Process knowledge files (if any)    â”‚                         â”‚
â”‚        â”‚  4. Execute playbook                    â”‚                         â”‚
â”‚        â”‚  5. Return results                      â”‚                         â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚               â”‚                                                             â”‚
â”‚               â–¼                                                             â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚        â”‚         Response (SSE Stream)           â”‚                         â”‚
â”‚        â”‚  - Analysis results                     â”‚                         â”‚
â”‚        â”‚  - tempFileId (for optional save)       â”‚                         â”‚
â”‚        â”‚  - reportDownloadUrl (24hr TTL)         â”‚                         â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚               â”‚                                                             â”‚
â”‚               â–¼                                                             â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚        â”‚  User Options:                          â”‚                         â”‚
â”‚        â”‚  â€¢ Download report                      â”‚                         â”‚
â”‚        â”‚  â€¢ Save file to SPE + create Document   â”‚                         â”‚
â”‚        â”‚  â€¢ Discard (auto-cleanup after 24hr)    â”‚                         â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Benefit**: Quick analysis without committing to storage. Great for previews and demos.

**Use Cases**:
- Preview analysis before uploading
- Analyze email attachments
- Demo/trial for prospects
- One-off analysis

---

## Unified API Design

**Single Endpoint for All Patterns:**

```
POST /api/ai/execute-playbook-stream
Content-Type: multipart/form-data (if files) or application/json (if IDs only)

Request Body:
{
  "playbookId": "PB-LEASE-001",
  "mode": "single" | "withKnowledge" | "comparison" | "consolidated",

  // Subject document(s) - at least one required
  "subjectDocumentId": "guid",              // Single SPE document
  "subjectDocumentIds": ["guid", "guid"],   // Multiple SPE documents
  "subjectFile": <multipart binary>,        // Ad-hoc upload

  // Knowledge files - optional, for RAG context
  "knowledgeFiles": [<multipart binary>, ...],
  "knowledgeDocumentIds": ["guid", ...],    // Existing SPE docs as knowledge

  // Options
  "options": {
    "generateReport": true,
    "reportFormat": "pdf" | "docx",
    "saveKnowledgeFiles": false             // Persist for reuse
  }
}
```

**Mode Behaviors:**

| Mode | Subject Input | Knowledge | Behavior |
|------|--------------|-----------|----------|
| `single` | 1 document | Playbook-configured only | Standard single-doc analysis |
| `withKnowledge` | 1 document | User-provided (RAG) | Subject analyzed with RAG context |
| `comparison` | 2+ documents | Optional | Documents compared side-by-side |
| `consolidated` | 2+ documents | Optional | Documents merged, analyzed as one |

---

## Unified Input Model (C#)

```csharp
public class PlaybookExecutionInput
{
    // === REQUIRED ===
    public Guid PlaybookId { get; set; }
    public AnalysisMode Mode { get; set; } = AnalysisMode.Single;

    // === SUBJECT DOCUMENT(S) ===

    /// Single SPE document (existing)
    public Guid? SubjectDocumentId { get; set; }

    /// Multiple SPE documents (comparison or consolidated)
    public Guid[]? SubjectDocumentIds { get; set; }

    /// Ad-hoc uploaded file (not in SPE)
    public UploadedFile? SubjectFile { get; set; }

    // === KNOWLEDGE FILES (RAG Context) ===

    /// User-uploaded knowledge files (session-scoped)
    public UploadedFile[]? KnowledgeFiles { get; set; }

    /// Existing SPE documents to use as knowledge
    public Guid[]? KnowledgeDocumentIds { get; set; }

    // === OPTIONS ===
    public AnalysisOptions Options { get; set; } = new();
}

public enum AnalysisMode
{
    Single,           // One subject, standard analysis
    WithKnowledge,    // One subject + uploaded knowledge (RAG)
    Comparison,       // Two+ subjects, compare them
    Consolidated      // Multiple subjects, analyze as one
}

public class UploadedFile
{
    public byte[] Content { get; set; }
    public string FileName { get; set; }
    public string ContentType { get; set; }
}

public class AnalysisOptions
{
    public bool GenerateReport { get; set; } = true;
    public string ReportFormat { get; set; } = "pdf";
    public bool SaveKnowledgeFiles { get; set; } = false;
}
```

---

## Knowledge File Processing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    KNOWLEDGE FILE PROCESSING                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  User uploads knowledge files at execution time                            â”‚
â”‚                                                                             â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚       â”‚  "Company_Standard_Lease_Terms.pdf"                      â”‚         â”‚
â”‚       â”‚  "Industry_Benchmarks_2026.pdf"                          â”‚         â”‚
â”‚       â”‚  "Previous_Approved_Lease.docx"                          â”‚         â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                              â”‚                                              â”‚
â”‚                              â–¼                                              â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚       â”‚  1. Extract text from each file                          â”‚         â”‚
â”‚       â”‚  2. Chunk into ~500 token segments                       â”‚         â”‚
â”‚       â”‚  3. Generate embeddings (text-embedding-ada-002)         â”‚         â”‚
â”‚       â”‚  4. Store in session vector index                        â”‚         â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                              â”‚                                              â”‚
â”‚                              â–¼                                              â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚       â”‚  Session Vector Store (Azure AI Search or in-memory)     â”‚         â”‚
â”‚       â”‚                                                          â”‚         â”‚
â”‚       â”‚  Chunks indexed by session ID:                           â”‚         â”‚
â”‚       â”‚  [0] "Security deposit shall not exceed 2 months..."    â”‚         â”‚
â”‚       â”‚  [1] "Standard escalation is CPI capped at 2.5%..."     â”‚         â”‚
â”‚       â”‚  [2] "Industry average TI allowance is $45/RSF..."      â”‚         â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                              â”‚                                              â”‚
â”‚                              â”‚  During node execution...                   â”‚
â”‚                              â–¼                                              â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚       â”‚  Compliance Analysis Node:                               â”‚         â”‚
â”‚       â”‚                                                          â”‚         â”‚
â”‚       â”‚  Prompt includes: "Use the provided knowledge context"  â”‚         â”‚
â”‚       â”‚                                                          â”‚         â”‚
â”‚       â”‚  RAG Query: "What is the standard security deposit?"    â”‚         â”‚
â”‚       â”‚        â”‚                                                 â”‚         â”‚
â”‚       â”‚        â–¼                                                 â”‚         â”‚
â”‚       â”‚  Retrieved: "Security deposit shall not exceed 2        â”‚         â”‚
â”‚       â”‚             months base rent per Company Policy..."     â”‚         â”‚
â”‚       â”‚        â”‚                                                 â”‚         â”‚
â”‚       â”‚        â–¼  Injected into prompt context                  â”‚         â”‚
â”‚       â”‚                                                          â”‚         â”‚
â”‚       â”‚  LLM compares subject lease against retrieved standard  â”‚         â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## UI Concept: Run Analysis Dialog

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         RUN ANALYSIS                                   [X] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ANALYSIS MODE                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â—‹ Single Document Analysis                                          â”‚  â”‚
â”‚  â”‚ â— Analyze with Knowledge Files (RAG)                                â”‚  â”‚
â”‚  â”‚ â—‹ Compare Documents                                                 â”‚  â”‚
â”‚  â”‚ â—‹ Consolidated Analysis (Multiple Documents)                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  SUBJECT DOCUMENT (Required)                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ“„ Lease_AcmeCorp_123Main.pdf                              [Remove]â”‚  â”‚
â”‚  â”‚     Source: Documents > Leases > 2026                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  [Select from Library...]  [Upload File...]                               â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  KNOWLEDGE FILES (Context for analysis via RAG)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ“„ Company_Standard_Terms.pdf                              [Remove]â”‚  â”‚
â”‚  â”‚  ğŸ“„ Industry_Benchmarks_2026.xlsx                           [Remove]â”‚  â”‚
â”‚  â”‚  ğŸ“„ Approved_Lease_Template.docx                            [Remove]â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  [+ Upload Knowledge File...]  [+ Select from Knowledge Library...]        â”‚
â”‚                                                                             â”‚
â”‚  â˜ Save knowledge files to library for future analyses                    â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  OUTPUT OPTIONS                                                            â”‚
â”‚  â˜‘ Generate PDF report                                                    â”‚
â”‚  â˜‘ Generate Word document                                                 â”‚
â”‚  â˜ Send email when complete                                               â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚                              [Cancel]              [â–¶ Run Analysis]        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Output Handling by Input Type

| Input Type | Analysis Output | Document Fields | Generated Report |
|------------|-----------------|-----------------|------------------|
| SPE Document | `sprk_analysisoutput` record | Updated on `sprk_document` | Saved to SPE |
| Ad-hoc File | Returned in response | N/A | Temp URL (24hr) |
| Multiple SPE | `sprk_analysisoutput` per? | TBD | Single consolidated report |
| Comparison | `sprk_analysisoutput` | N/A (comparison) | Comparison report |

---

## Security Considerations

| Concern | Mitigation |
|---------|------------|
| Unauthorized file analysis | Require authentication, rate limiting |
| Large file uploads | Max file size (50MB), max 10 documents |
| Temp storage abuse | 24hr TTL, per-user quotas |
| Sensitive data in temp | Encryption at rest, secure delete |
| Cost control | Track token usage, enforce limits |
| Context overflow | Validate total text size before execution |

---

## Implementation Tasks

**Phase 1: Core Infrastructure (1-2 weeks)**
- [ ] Create `PlaybookExecutionInput` unified model
- [ ] Refactor orchestration to accept unified input
- [ ] Add text merge utility for multi-document
- [ ] Add temp file storage service (Azure Blob)
- [ ] Add file upload endpoint

**Phase 2: Knowledge Files / RAG (1-2 weeks)**
- [ ] Add session-scoped vector store
- [ ] Implement chunk & embed pipeline
- [ ] Integrate RAG retrieval into node execution
- [ ] Add knowledge file persistence option

**Phase 3: UI (1 week)**
- [ ] Create "Run Analysis" dialog component
- [ ] Add mode selection
- [ ] Add file upload with drag-drop
- [ ] Add knowledge file management

**Phase 4: Cleanup & Polish**
- [ ] Temp file cleanup job
- [ ] Rate limiting
- [ ] Documentation
- [ ] Testing

---

## Effort Estimate

| Component | Effort |
|-----------|--------|
| Unified input model | 2-3 days |
| Multi-doc text merge | 1-2 days |
| Ad-hoc file handling | 3-4 days |
| Knowledge file RAG | 5-7 days |
| UI dialog | 3-4 days |
| Testing & polish | 3-4 days |
| **Total** | **3-4 weeks** |

---

## Revision History

| Date | Changes |
|------|---------|
| 2026-01-16 | Initial design (extracted from design.md) |
