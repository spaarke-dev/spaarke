# AI Node-Based Playbook Builder

> **Status**: In Progress
> **Created**: 2026-01-08
> **Branch**: work/ai-node-playbook-builder

## Overview

Transform Spaarke's current single-action playbook model into a **multi-node orchestration platform** that enables:

- Chaining multiple AI analysis actions with data flow between nodes
- Mixing AI (probabilistic) and deterministic actions in a single playbook
- Visual drag-and-drop playbook construction for business analysts
- Flexible delivery outputs (documents, emails, records, Teams messages)
- Per-node AI model selection for cost/quality optimization

## Design Philosophy

**Extend, don't replace.** This project adds an orchestration layer on top of the existing analysis pipeline. Core components (`IAnalysisToolHandler`, `OpenAiClient`, `ScopeResolverService`, etc.) remain unchanged and are reused by the new orchestration layer.

## Key Deliverables

### Phase 1: Foundation
- [ ] Dataverse schema (new entities: `sprk_playbooknode`, `sprk_aimodeldeployment`, `sprk_deliverytemplate`, `sprk_playbookrun`, `sprk_playbooknoderun`)
- [ ] `INodeService` / `NodeService` for node management
- [ ] Extended `IScopeResolverService` with node scope resolution
- [ ] `ExecutionGraph` for dependency resolution
- [ ] `AiAnalysisNodeExecutor` bridging to existing pipeline
- [ ] `PlaybookOrchestrationService` with sequential execution
- [ ] Node management API endpoints

### Phase 2: Visual Builder
- [ ] React 18 playbook-builder app with React Flow
- [ ] `PlaybookBuilderHost` PCF control with iframe embedding
- [ ] Host-builder postMessage communication
- [ ] Node palette, properties panel, canvas controls

### Phase 3: Parallel Execution + Delivery
- [ ] Parallel node execution with throttling
- [ ] Delivery node executors (CreateTask, SendEmail, DeliverOutput)
- [ ] `ITemplateEngine` (Handlebars.NET)
- [ ] Power Apps template integration

### Phase 4: Advanced Features
- [ ] `ConditionNodeExecutor` for branching
- [ ] Per-node model selection UI
- [ ] Confidence score display
- [ ] Playbook templates library

### Phase 5: Production Hardening
- [ ] Error handling and retry logic
- [ ] Timeout management and cancellation
- [ ] Audit logging
- [ ] Performance optimization

## Graduation Criteria

| Metric | Target | Status |
|--------|--------|--------|
| Playbook creation time | <10 minutes for 5-node playbook | Pending |
| Execution latency (5 nodes) | <60 seconds | Pending |
| UI responsiveness | <100ms for drag/drop | Pending |
| Backward compatibility | 100% existing playbooks work | Pending |
| DI registrations | ≤15 non-framework | Pending |
| Test coverage | Unit + Integration + E2E deploy | Pending |

## Technical Constraints

- **ADR-001**: Minimal API pattern, no Azure Functions
- **ADR-008**: Endpoint filters for authorization
- **ADR-010**: ≤15 non-framework DI registrations
- **ADR-013**: Extend BFF API, no separate microservice
- **ADR-022**: PCF uses React 16; iframe isolates React 18 builder

## Quick Links

- [Implementation Specification](spec.md)
- [Implementation Plan](plan.md)
- [Task Index](tasks/TASK-INDEX.md)
- [Project Context](CLAUDE.md)

## Getting Started

```bash
# Execute tasks sequentially
work on task 001

# Check project status
/project-status ai-node-playbook-builder
```

---

*Generated by Claude Code project-pipeline*
