<?xml version="1.0" encoding="UTF-8"?>
<task id="029" project="home-corporate-workspace-r1">
  <metadata>
    <title>System-Generated To-Do Items — BFF Scheduled Job</title>
    <phase>Phase 3: Action Cards &amp; Dialogs</phase>
    <status>not-started</status>
    <estimated-hours>8</estimated-hours>
    <dependencies>017, 018</dependencies>
    <blocks>none</blocks>
    <tags>bff-api, api, backend, worker</tags>
    <rigor-hint>FULL</rigor-hint>
    <rigor-reason>bff-api tag with code implementation — BackgroundService with Dataverse writes, idempotency logic, and multiple auto-generation rules</rigor-reason>
    <parallel-group>pg-scoring</parallel-group>
    <parallel-safe>true</parallel-safe>
  </metadata>

  <prompt>
    Create a BFF scheduled background job that automatically generates to-do items for actionable conditions:
    overdue events, budget exceeding 85% utilization, deadlines within 14 days, pending invoices, and assigned
    tasks. The job creates sprk_event records with sprk_todoflag=true, sprk_todosource='System', and
    sprk_todostatus='Open'. The job MUST be idempotent — re-running it should never create duplicate to-do items.
    Use standard title patterns (e.g., "Overdue: {event title}", "Budget Alert: {matter name}"). Schedule as
    a daily periodic BackgroundService.
  </prompt>

  <role>SPAARKE platform developer. Expert in .NET 8 BackgroundService for scheduled jobs, Dataverse WebAPI for CRUD operations, idempotent job design, and production-grade background processing with error handling and logging.</role>

  <goal>
    A TodoGenerationService that runs as a periodic BackgroundService (daily schedule). The service queries
    Dataverse for conditions that warrant to-do items (overdue events, high budget utilization, approaching
    deadlines, pending invoices, assigned tasks), checks for existing to-dos (idempotency), and creates new
    sprk_event records with to-do flags set. The service uses standard title patterns, handles errors gracefully
    per-item (one failure does not block others), and logs all actions. Unit tests verify idempotency.
  </goal>

  <context>
    <background>
      The Smart To Do list (Block 4) displays to-do items from three sources: System (auto-generated by this job),
      User (manually created in the to-do input bar), and Flagged (flagged from the activity feed). This task
      implements the System source. The job runs daily and scans for conditions that legal operations managers
      should act on. It creates to-do items as sprk_event records with sprk_todoflag=true to distinguish them
      from regular events. Idempotency is critical — if a to-do already exists for a given condition (same
      title pattern + regarding entity), the job must skip it rather than create a duplicate.
    </background>
    <relevant-files>
      <file>projects/home-corporate-workspace-r1/spec.md</file>
      <file>projects/home-corporate-workspace-r1/CLAUDE.md</file>
      <file>src/server/api/Sprk.Bff.Api/Services/Workspace/</file>
      <file>src/server/api/Sprk.Bff.Api/Infrastructure/DI/</file>
      <file>src/server/api/Sprk.Bff.Api/Api/Infrastructure/ProblemDetailsHelper.cs</file>
    </relevant-files>
  </context>

  <constraints>
    <constraint source="ADR-001">MUST use BackgroundService for scheduled work — NOT Azure Functions, NOT hosted service alternatives</constraint>
    <constraint source="ADR-010">DI registrations MUST count toward ≤15 non-framework limit — use module extension method</constraint>
    <constraint source="spec">To-do records MUST set: sprk_todoflag=true, sprk_todosource='System', sprk_todostatus='Open'</constraint>
    <constraint source="spec">Job MUST be idempotent — no duplicate to-do items on re-run</constraint>
    <constraint source="spec">Standard title patterns: "Overdue: {event title}", "Budget Alert: {matter name}", "Deadline: {event title} (due {date})", "Invoice Pending: {invoice title}", "Assigned: {task title}"</constraint>
    <constraint source="spec">Auto-to-do criteria: overdue events, budget &gt;85%, deadline within 14 days, pending invoices, assigned tasks</constraint>
  </constraints>

  <knowledge>
    <files>
      <file>.claude/constraints/api.md</file>
      <file>.claude/constraints/jobs.md</file>
      <file>.claude/patterns/api/service-registration.md</file>
      <file>.claude/patterns/dataverse/entity-operations.md</file>
      <file>.claude/adr/ADR-001.md</file>
      <file>.claude/adr/ADR-010.md</file>
      <file>src/server/api/Sprk.Bff.Api/CLAUDE.md</file>
    </files>
    <patterns>
      <pattern name="entity-operations" location=".claude/patterns/dataverse/entity-operations.md">Dataverse WebAPI query and create operations for sprk_event records</pattern>
      <pattern name="service-registration" location=".claude/patterns/api/service-registration.md">Module extension method for DI registration and BackgroundService hosting</pattern>
      <pattern name="background-service" location="src/server/api/Sprk.Bff.Api/">Look for existing BackgroundService implementations as reference pattern</pattern>
    </patterns>
  </knowledge>

  <steps>
    <step order="1">Create TodoGenerationService class (TodoGenerationService.cs) in src/server/api/Sprk.Bff.Api/Services/Workspace/ — extends BackgroundService with a PeriodicTimer (24-hour interval)</step>
    <step order="2">Implement overdue events rule — query Dataverse for sprk_event records where duedate &lt; today AND sprk_todoflag != true. For each, check if a "Overdue: {subject}" to-do already exists (idempotent). If not, create new sprk_event with sprk_todoflag=true, sprk_todosource='System', sprk_todostatus='Open', subject="Overdue: {original subject}", regarding=original event.</step>
    <step order="3">Implement budget alert rule — query Dataverse for sprk_matter records where utilizationpercent &gt; 85. For each, check if a "Budget Alert: {matter name}" to-do already exists. If not, create new sprk_event with to-do flags and title pattern.</step>
    <step order="4">Implement deadline proximity rule — query Dataverse for sprk_event records where duedate is within 14 days from today AND sprk_todoflag != true. For each, check for existing "Deadline: {subject} (due {date})" to-do. If not exists, create to-do event.</step>
    <step order="5">Implement pending invoices rule — query Dataverse for sprk_event records of type 'Invoice' with status 'Pending'. For each, check for existing "Invoice Pending: {subject}" to-do. If not exists, create to-do event.</step>
    <step order="6">Implement assigned tasks rule — query Dataverse for sprk_event records of type 'Task' assigned to the current user/owner. For each, check for existing "Assigned: {subject}" to-do. If not exists, create to-do event.</step>
    <step order="7">Implement idempotency check — for each candidate to-do, query Dataverse for existing sprk_event records with matching subject pattern AND sprk_todosource='System' AND sprk_todostatus != 'Dismissed'. Skip creation if match found.</step>
    <step order="8">Add error handling per-item — wrap each to-do creation in try/catch so one failure does not block others. Log errors with ILogger including entity details for debugging. Track success/failure counts.</step>
    <step order="9">Add unit tests for idempotency — test that running the job twice with same data produces no duplicates. Test that dismissed to-dos are not re-created. Test each rule in isolation.</step>
    <step order="10">Register TodoGenerationService in DI — use AddHostedService&lt;TodoGenerationService&gt; via module extension method. Ensure total non-framework DI registrations stay ≤15.</step>
    <step order="11">Verify dotnet build and dotnet test succeed with no errors</step>
    <step order="12">Update TASK-INDEX.md — mark task 029 as complete</step>
  </steps>

  <tools>
    <tool name="dotnet">Build and test .NET projects</tool>
  </tools>

  <outputs>
    <output type="code">src/server/api/Sprk.Bff.Api/Services/Workspace/TodoGenerationService.cs</output>
    <output type="code">tests/Sprk.Bff.Api.Tests/Services/Workspace/TodoGenerationServiceTests.cs</output>
  </outputs>

  <acceptance-criteria>
    <criterion testable="true">TodoGenerationService runs as a periodic BackgroundService with 24-hour interval</criterion>
    <criterion testable="true">Overdue events rule creates to-dos with "Overdue: {subject}" title pattern</criterion>
    <criterion testable="true">Budget alert rule creates to-dos for matters with utilization &gt;85%</criterion>
    <criterion testable="true">Deadline proximity rule creates to-dos for events due within 14 days</criterion>
    <criterion testable="true">Pending invoice rule creates to-dos with "Invoice Pending: {subject}" title</criterion>
    <criterion testable="true">Assigned task rule creates to-dos with "Assigned: {subject}" title</criterion>
    <criterion testable="true">All created to-dos have sprk_todoflag=true, sprk_todosource='System', sprk_todostatus='Open'</criterion>
    <criterion testable="true">Job is idempotent — re-running produces zero duplicate to-do items</criterion>
    <criterion testable="true">Dismissed to-dos (sprk_todostatus='Dismissed') are not re-created</criterion>
    <criterion testable="true">Individual item failures do not block processing of other items</criterion>
    <criterion testable="true">Unit tests verify idempotency for each rule</criterion>
    <criterion testable="true">TodoGenerationService is registered in DI via module extension method</criterion>
    <criterion testable="true">Total non-framework DI registrations remain ≤15</criterion>
    <criterion testable="true">Solution builds and all tests pass (dotnet build &amp;&amp; dotnet test)</criterion>
  </acceptance-criteria>

  <notes>
    - Look for existing BackgroundService implementations in the BFF project for the periodic timer pattern
    - ADR-001 mandates BackgroundService over Azure Functions — this is intentional for process affinity
    - The 24-hour interval should be configurable via appsettings.json (default: run at 2 AM UTC)
    - Idempotency is the most critical requirement — test thoroughly with duplicates
    - Consider adding a "last run" timestamp to avoid re-scanning the entire dataset each time
    - The Dataverse queries should use $filter and $select for efficiency — do not retrieve all fields
    - For the assigned tasks rule, "current user" means the service account — consider making owner configurable
    - Log a summary at the end of each run: "TodoGeneration completed: {created} created, {skipped} skipped, {failed} failed"
    - Dismissed to-dos should never be re-created — users explicitly dismissed them
    - Consider adding a manual trigger endpoint (POST /api/workspace/todos/generate) for testing purposes
  </notes>

  <execution>
    <skill>.claude/skills/task-execute/SKILL.md</skill>
    <protocol>Load all knowledge files before starting. Follow task-execute skill protocol. Checkpoint after steps 3, 7, and 10 due to task complexity.</protocol>
  </execution>
</task>
