<?xml version="1.0" encoding="UTF-8"?>
<task id="012" project="home-corporate-workspace-r1">
  <metadata>
    <title>Block 3D - Flag-as-ToDo Toggle</title>
    <phase>Phase 2: Core Feature Blocks</phase>
    <status>not-started</status>
    <estimated-hours>6</estimated-hours>
    <dependencies>011, 003</dependencies>
    <blocks>014</blocks>
    <tags>pcf, react, fluent-ui, frontend, dataverse</tags>
    <rigor-hint>FULL</rigor-hint>
    <rigor-reason>PCF tag with Dataverse persistence, cross-component state synchronization (feed â†” to-do), and NFR-08 performance constraint (&lt;1s persist)</rigor-reason>
    <parallel-group>pg-phase2-feed</parallel-group>
    <parallel-safe>true</parallel-safe>
  </metadata>

  <prompt>
    Implement the flag-as-to-do toggle on feed item cards. When a user clicks the flag button on a FeedItemCard,
    it creates or removes a to-do flag on the underlying Dataverse Event record (sprk_todoflag field). The flag
    state must persist to Dataverse within 1 second (NFR-08). Create a shared state context (FeedTodoSyncContext)
    that enables cross-component synchronization between the Updates Feed (Block 3) and the Smart To Do list
    (Block 4). The flag toggle uses optimistic UI updates â€” show the flagged state immediately before the
    Dataverse write completes. On flag: set sprk_todoflag=true and sprk_todosource='User'. On unflag: set
    sprk_todoflag=false.
  </prompt>

  <role>SPAARKE platform developer. Expert in Dataverse Xrm.WebApi CRUD operations, React 18 context/state management, optimistic UI patterns, and cross-component synchronization.</role>

  <goal>
    Flag toggle on FeedItemCard persists to Dataverse (sprk_todoflag and sprk_todosource fields) within 1 second.
    Optimistic UI update shows flagged state immediately. FeedTodoSyncContext provides cross-component state
    sharing so Block 4 (Smart To Do) can react to flag changes. To Do badge count updates when flags change.
    Unflagging removes the to-do state. All state changes are reversible on Dataverse write failure.
  </goal>

  <context>
    <background>
      The flag-as-to-do feature (Block 3D) is the critical bridge between the Updates Feed and the Smart To Do
      list. When a user flags a feed item, it creates a to-do entry that appears in Block 4. This requires
      cross-component state synchronization â€” the feed needs to know the current flag state of each event, and
      the to-do list needs to react when flags are added or removed. The shared state context
      (FeedTodoSyncContext) is the mechanism for this synchronization. Optimistic updates ensure the UI feels
      instant while the Dataverse write happens in the background. If the write fails, the UI reverts.
    </background>
    <relevant-files>
      <file>src/client/pcf/LegalWorkspace/components/ActivityFeed/FeedItemCard.tsx</file>
      <file>src/client/pcf/LegalWorkspace/services/DataverseService.ts</file>
      <file>projects/home-corporate-workspace-r1/spec.md</file>
    </relevant-files>
  </context>

  <constraints>
    <constraint source="NFR-08">To-do flag toggle MUST persist to Dataverse within 1 second</constraint>
    <constraint source="spec">On flag: set sprk_todoflag=true, sprk_todosource='User' on the Event record</constraint>
    <constraint source="spec">On unflag: set sprk_todoflag=false on the Event record</constraint>
    <constraint source="spec">Hybrid data access â€” use Xrm.WebApi for direct entity updates (client-side CRUD)</constraint>
    <constraint source="ADR-021">All UI MUST use Fluent UI v9 semantic tokens</constraint>
    <constraint source="ADR-021">MUST support light mode, dark mode, and high-contrast mode</constraint>
  </constraints>

  <knowledge>
    <files>
      <file>.claude/constraints/pcf.md</file>
      <file>.claude/constraints/data.md</file>
      <file>.claude/patterns/dataverse/entity-operations.md</file>
      <file>.claude/adr/ADR-021.md</file>
      <file>projects/home-corporate-workspace-r1/spec.md</file>
    </files>
    <patterns>
      <pattern name="entity-operations" location=".claude/patterns/dataverse/entity-operations.md">Xrm.WebApi CRUD patterns for updating entity records</pattern>
      <pattern name="optimistic-update" location="src/client/pcf/AnalysisWorkspace/">Reference for optimistic UI update patterns with rollback on failure</pattern>
    </patterns>
  </knowledge>

  <steps>
    <step order="1">Add toggleTodoFlag method to DataverseService â€” accepts eventId, flagState (true/false). On flag: update sprk_event record with sprk_todoflag=true, sprk_todosource='User'. On unflag: update sprk_todoflag=false. Use Xrm.WebApi.updateRecord.</step>
    <step order="2">Create FeedTodoSyncContext (React Context + Provider) at src/client/pcf/LegalWorkspace/contexts/FeedTodoSyncContext.tsx â€” maintains a map of eventId â†’ flagState. Provides methods: toggleFlag(eventId), isFlagged(eventId), getFlaggedCount(). Exposes a subscription mechanism for Block 4 to consume changes.</step>
    <step order="3">Create useFeedTodoSync hook that wraps FeedTodoSyncContext â€” provides convenient access to toggle, query, and subscribe to flag state changes from any component.</step>
    <step order="4">Wire flag toggle handler in FeedItemCard â€” on click: 1) Optimistically update FeedTodoSyncContext (immediate UI change), 2) Call DataverseService.toggleTodoFlag in background, 3) On failure: revert context state and show error toast.</step>
    <step order="5">Implement optimistic update with rollback â€” store previous state before toggle. If Dataverse write fails, revert to previous state in FeedTodoSyncContext. Show a brief error notification using Fluent v9 Toast or MessageBar.</step>
    <step order="6">Create state change event emission mechanism â€” when a flag is toggled, emit an event that Block 4 (Smart To Do) can consume to add/remove items from its list. Use context subscription or a lightweight event emitter pattern.</step>
    <step order="7">Update FilterBar counts â€” the "All" count and any relevant filter counts should reflect flag changes. Ensure the feed re-filters correctly when flag state changes.</step>
    <step order="8">Verify persistence timing â€” ensure Dataverse write completes within 1 second (NFR-08). Test with network monitoring. Add performance logging.</step>
    <step order="9">Update TASK-INDEX.md â€” mark task 012 as complete (change ðŸ”² to âœ…)</step>
  </steps>

  <tools>
    <tool name="npm">Build TypeScript/PCF projects</tool>
    <tool name="terminal">Run shell commands for build verification</tool>
  </tools>

  <outputs>
    <output type="code">src/client/pcf/LegalWorkspace/contexts/FeedTodoSyncContext.tsx</output>
    <output type="code">src/client/pcf/LegalWorkspace/hooks/useFeedTodoSync.ts</output>
    <output type="code">src/client/pcf/LegalWorkspace/services/DataverseService.ts (updated)</output>
    <output type="code">src/client/pcf/LegalWorkspace/components/ActivityFeed/FeedItemCard.tsx (updated)</output>
  </outputs>

  <acceptance-criteria>
    <criterion testable="true">Flag toggle on FeedItemCard calls DataverseService.toggleTodoFlag and persists sprk_todoflag to Dataverse</criterion>
    <criterion testable="true">On flag: sprk_todoflag is set to true and sprk_todosource is set to 'User' on the Event record</criterion>
    <criterion testable="true">On unflag: sprk_todoflag is set to false on the Event record</criterion>
    <criterion testable="true">Optimistic UI update shows flagged state immediately (before Dataverse write completes)</criterion>
    <criterion testable="true">On Dataverse write failure, UI reverts to previous state and shows error feedback</criterion>
    <criterion testable="true">FeedTodoSyncContext provides isFlagged(eventId) and toggleFlag(eventId) methods</criterion>
    <criterion testable="true">State change events are emitted for Block 4 (Smart To Do) to consume</criterion>
    <criterion testable="true">Dataverse persistence completes within 1 second (NFR-08)</criterion>
    <criterion testable="true">To Do badge count updates when flags are added or removed</criterion>
    <criterion testable="true">PCF control builds without TypeScript or webpack errors</criterion>
  </acceptance-criteria>

  <notes>
    - The FeedTodoSyncContext is the bridge between Block 3 (feed) and Block 4 (to-do list) â€” it must be placed high enough in the component tree (in LegalWorkspaceApp.tsx) to be accessible by both blocks
    - Optimistic updates are critical for perceived performance â€” the UI must feel instant even though Dataverse writes take time
    - Consider using useReducer for complex state management in the context (flag map, pending writes, error state)
    - The sprk_todosource field differentiates how items were flagged: 'User' (manual flag), 'System' (auto-generated), 'AI' (future)
    - When unflagging, keep sprk_todosource unchanged (it tracks the original source)
    - Task 014 (Smart To Do) will consume the FeedTodoSyncContext to display flagged items
    - Consider debouncing rapid flag toggles to prevent excessive Dataverse writes
  </notes>

  <execution>
    <skill>.claude/skills/task-execute/SKILL.md</skill>
    <protocol>Load all knowledge files before starting. Follow task-execute skill protocol. Checkpoint after steps 4 and 7.</protocol>
  </execution>
</task>
