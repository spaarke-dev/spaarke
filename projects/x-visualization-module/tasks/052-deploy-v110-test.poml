<?xml version="1.0" encoding="utf-8"?>
<task id="052" project="visualization-module">
  <metadata>
    <title>Deploy Visual Host v1.1.0 and Integration Testing</title>
    <phase>6</phase>
    <status>in-progress</status>
    <estimate>3 hours</estimate>
    <dependencies>050, 051</dependencies>
    <tags>deployment, testing, dataverse, pcf</tags>
    <created>2025-12-30</created>
  </metadata>

  <prompt>
    <goal>
      Deploy Visual Host v1.1.0 to Dataverse and validate all enhancement scenarios.
    </goal>

    <context>
      Visual Host v1.1.0 includes:
      - Hybrid chart selection (lookup OR static ID)
      - Context filtering (show related records only)

      Chart Definition form includes:
      - Reporting Entity lookup with logical name sync
      - Reporting View lookup (filtered by entity) with GUID sync

      Must validate all configuration scenarios work correctly.
    </context>

    <constraints>
      - MUST deploy to dev environment (https://spaarkedev1.crm.dynamics.com)
      - MUST use pac pcf push for deployment
      - MUST verify backward compatibility with existing charts
      - MUST test all new features
    </constraints>
  </prompt>

  <knowledge>
    <files>
      <file>src/client/pcf/VisualHost/control/ControlManifest.Input.xml</file>
      <file>projects/visualization-module/notes/power-app-setup-guide.md</file>
      <file>.claude/skills/dataverse-deploy/SKILL.md</file>
    </files>
  </knowledge>

  <steps>
    <step id="1">
      <action>Build Visual Host PCF</action>
      <details>
        cd src/client/pcf/VisualHost
        npm run build
        Verify build succeeds and bundle size is acceptable.
      </details>
    </step>

    <step id="2">
      <action>Deploy to Dataverse</action>
      <details>
        Use pac pcf push to deploy v1.1.0.
        Verify control version in Dataverse (should show 1.1.0).
      </details>
    </step>

    <step id="3">
      <action>Upload Chart Definition form JavaScript</action>
      <details>
        1. Upload sprk_chartdefinition_form.js as web resource
        2. Register OnLoad event on Chart Definition main form
        3. Configure related records filtering on sprk_reportingview lookup
        4. Publish customizations
      </details>
    </step>

    <step id="4">
      <action>Test Scenario 1: Static ID binding</action>
      <details>
        1. Place Visual Host on test form without lookup binding
        2. Configure chartDefinitionId with a test chart GUID
        3. Verify chart renders correctly
        4. Place second Visual Host with different static ID
        5. Verify both charts render (multiple charts per form)
      </details>
    </step>

    <step id="5">
      <action>Test Scenario 2: Lookup binding</action>
      <details>
        1. Create lookup field on test entity → sprk_chartdefinition
        2. Place Visual Host bound to lookup field
        3. Select different chart definitions per record
        4. Verify each record shows correct chart
      </details>
    </step>

    <step id="6">
      <action>Test Scenario 3: Hybrid (lookup + static fallback)</action>
      <details>
        1. Configure Visual Host with both lookup binding AND static ID
        2. Test record with lookup value → should use lookup
        3. Test record without lookup value → should use static ID
        4. Verify precedence: lookup takes priority
      </details>
    </step>

    <step id="7">
      <action>Test Scenario 4: Context filtering</action>
      <details>
        1. Configure Visual Host with contextFieldName (e.g., _sprk_matterid_value)
        2. Place on Matter form
        3. Create related records (e.g., Documents with Matter lookup)
        4. Verify chart only shows related Documents
        5. Test on different Matter record → different data
      </details>
    </step>

    <step id="8">
      <action>Test Chart Definition form UX</action>
      <details>
        1. Create new Chart Definition record
        2. Select Reporting Entity → verify view lookup filters
        3. Select Reporting View → verify backing fields populated
        4. Change entity → verify view clears and backing fields reset
        5. Save record → verify all values persisted
      </details>
    </step>

    <step id="9">
      <action>Update documentation</action>
      <details>
        Update power-app-setup-guide.md with:
        - v1.1.0 features and configuration
        - All supported scenarios
        - Troubleshooting for new features
      </details>
    </step>
  </steps>

  <tools>
    <tool>Bash</tool>
    <tool>Read</tool>
    <tool>Edit</tool>
  </tools>

  <outputs>
    <output>Visual Host v1.1.0 deployed to Dataverse</output>
    <output>Chart Definition form JavaScript registered</output>
    <output>All test scenarios validated</output>
    <output>Updated documentation</output>
  </outputs>

  <acceptance-criteria>
    <criterion>Visual Host v1.1.0 deployed and visible in Dataverse</criterion>
    <criterion>Static ID binding works (multiple charts per form)</criterion>
    <criterion>Lookup binding works (per-record chart selection)</criterion>
    <criterion>Hybrid mode works (lookup precedence over static)</criterion>
    <criterion>Context filtering works (shows related records only)</criterion>
    <criterion>Chart Definition form lookups work with auto-sync</criterion>
    <criterion>Related records filtering works on view lookup</criterion>
    <criterion>Backward compatibility with existing v1.0.x charts</criterion>
  </acceptance-criteria>
</task>
