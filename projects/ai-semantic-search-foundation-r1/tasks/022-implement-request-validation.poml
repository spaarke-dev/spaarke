<?xml version="1.0" encoding="UTF-8"?>
<task id="022" project="ai-semantic-search-foundation-r1">
  <metadata>
    <title>Implement request validation with stable error codes</title>
    <phase>3: API Endpoints &amp; Authorization</phase>
    <status>not-started</status>
    <estimated-hours>2</estimated-hours>
    <dependencies>020, 021</dependencies>
    <blocks>023</blocks>
    <tags>bff-api, ai, validation</tags>
    <rigor-hint>FULL</rigor-hint>
    <rigor-reason>Validation critical for API contract enforcement</rigor-reason>
  </metadata>

  <prompt>
    Implement request validation for the semantic search endpoints that checks all
    request constraints and returns stable error codes per spec.md. Validation must
    happen before the authorization filter.
  </prompt>

  <role>
    SPAARKE platform developer. Expert in .NET validation and API error handling.
    Follow ADR-019 for ProblemDetails error responses.
  </role>

  <goal>
    Request validation that checks:
    - Query length (1-2000 characters)
    - Scope validity (entity or documentIds)
    - Entity scope requires entityType and entityId
    - DocumentIds scope requires documentIds array
    - Limit bounds (1-100, default 20)
    All failures return 400 with stable error codes.
  </goal>

  <context>
    <background>
      The spec.md defines specific error codes for each validation failure:
      - QUERY_REQUIRED, QUERY_TOO_LONG
      - INVALID_SCOPE, MISSING_ENTITY_TYPE, MISSING_ENTITY_ID
      - MISSING_DOCUMENT_IDS, TOO_MANY_DOCUMENT_IDS
      - INVALID_LIMIT, INVALID_OFFSET
      Validation filter runs BEFORE authorization filter.
    </background>
    <relevant-files>
      <file>projects/ai-semantic-search-foundation-r1/spec.md</file>
      <file>src/server/api/Sprk.Bff.Api/Api/Filters/</file>
    </relevant-files>
  </context>

  <constraints>
    <constraint source="ADR-019">Return ProblemDetails for all validation errors</constraint>
    <constraint source="spec">Error codes must match spec.md exactly</constraint>
    <constraint source="spec">All validation errors return 400</constraint>
    <constraint source="spec">Validation runs before authorization</constraint>
  </constraints>

  <knowledge>
    <files>
      <file>.claude/adr/ADR-019-problemdetails.md</file>
      <file>.claude/patterns/api/error-handling.md</file>
      <file>projects/ai-semantic-search-foundation-r1/spec.md</file>
    </files>
    <patterns>
      <pattern name="Validation Pattern" location="src/server/api/Sprk.Bff.Api/Api/">
        Follow existing validation patterns in the API
      </pattern>
    </patterns>
  </knowledge>

  <steps>
    <step order="1">Read spec.md Request Validation Rules section</step>
    <step order="2">Create SemanticSearchValidationFilter.cs implementing IEndpointFilter</step>
    <step order="3">Implement query validation (required, 1-2000 chars)</step>
    <step order="4">Implement scope validation (must be entity or documentIds)</step>
    <step order="5">Implement entity scope validation (requires entityType and entityId)</step>
    <step order="6">Implement documentIds scope validation (requires documentIds, max 100)</step>
    <step order="7">Implement limit validation (1-100, default 20)</step>
    <step order="8">Implement offset validation (>= 0, default 0)</step>
    <step order="9">Return ProblemDetails with stable error codes</step>
    <step order="10">Apply filter BEFORE authorization filter in SemanticSearchEndpoints.cs</step>
    <step order="11">Run dotnet build to verify compilation</step>
    <step order="12">Update TASK-INDEX.md: change task 022 status to âœ… completed</step>
  </steps>

  <tools>
    <tool name="dotnet">Build .NET projects</tool>
  </tools>

  <outputs>
    <output type="code">src/server/api/Sprk.Bff.Api/Api/Filters/SemanticSearchValidationFilter.cs</output>
    <output type="code">src/server/api/Sprk.Bff.Api/Api/Ai/SemanticSearchEndpoints.cs (modified)</output>
  </outputs>

  <acceptance-criteria>
    <criterion testable="true">Validation filter exists and runs before auth filter</criterion>
    <criterion testable="true">QUERY_REQUIRED returned when query missing/empty</criterion>
    <criterion testable="true">QUERY_TOO_LONG returned when query > 2000 chars</criterion>
    <criterion testable="true">INVALID_SCOPE returned for non entity/documentIds scope</criterion>
    <criterion testable="true">MISSING_ENTITY_TYPE/ID returned when entity scope incomplete</criterion>
    <criterion testable="true">MISSING_DOCUMENT_IDS returned when documentIds scope has no IDs</criterion>
    <criterion testable="true">Error codes match spec.md exactly</criterion>
    <criterion testable="true">dotnet build succeeds without errors</criterion>
  </acceptance-criteria>

  <execution>
    <skill>.claude/skills/task-execute/SKILL.md</skill>
    <protocol>
      Before starting this task, load all files listed in knowledge/files.
      Follow the task-execute skill for mandatory pre-execution checklist.
    </protocol>
  </execution>
</task>
