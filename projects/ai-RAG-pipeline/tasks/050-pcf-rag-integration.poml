<?xml version="1.0" encoding="UTF-8"?>
<task id="050" project="ai-RAG-pipeline">
  <metadata>
    <title>Implement PCF RAG indexing call after upload</title>
    <phase>5: PCF Integration</phase>
    <status>not-started</status>
    <estimated-hours>2</estimated-hours>
    <dependencies>016</dependencies>
    <blocks>051</blocks>
    <tags>pcf, react, typescript, frontend</tags>
    <rigor-hint>FULL</rigor-hint>
    <rigor-reason>Task modifies PCF control with API integration</rigor-reason>
  </metadata>

  <prompt>
    Implement client-side RAG indexing call in the PCF upload control. After a successful
    file upload to SPE, call the POST /api/ai/rag/index-file endpoint. The call should be
    non-blocking - failures are logged as warnings, not shown to users.
  </prompt>

  <role>
    SPAARKE platform developer. Expert in PCF controls and TypeScript.
    Follow ADR-006 for PCF patterns and ADR-021 for Fluent UI.
  </role>

  <goal>
    PCF upload control triggers RAG indexing after successful file upload.
    Users don't see RAG errors - failures are silent.
  </goal>

  <context>
    <background>
      The PCF upload control handles file uploads to SharePoint Embedded. After a
      successful upload, we should call the RAG indexing endpoint to make the document
      searchable. This provides immediate indexing for user uploads.
    </background>
    <relevant-files>
      <file>src/client/pcf/</file>
      <file>projects/ai-RAG-pipeline/design.md</file>
    </relevant-files>
  </context>

  <constraints>
    <constraint source="ADR-006">Follow PCF patterns</constraint>
    <constraint source="project">Non-blocking - failures logged but not shown to users</constraint>
    <constraint source="project">Use existing API client patterns</constraint>
  </constraints>

  <knowledge>
    <files>
      <file>.claude/adr/ADR-006-pcf-controls.md</file>
      <file>.claude/constraints/pcf.md</file>
      <file>src/client/pcf/CLAUDE.md</file>
      <file>docs/guides/PCF-V9-PACKAGING.md</file>
    </files>
    <patterns>
      <pattern name="PCF API Call" location="src/client/pcf/">
        Reference existing API call patterns in PCF controls
      </pattern>
    </patterns>
  </knowledge>

  <steps>
    <step order="1">Identify the PCF upload control that handles file uploads</step>
    <step order="2">Find the location in the upload flow where upload succeeds</step>
    <step order="3">Create indexDocumentToRag async function with driveId, itemId, tenantId parameters</step>
    <step order="4">Call POST /api/ai/rag/index-file with fetch or existing API client</step>
    <step order="5">Wrap in try/catch - log warning on failure, don't throw</step>
    <step order="6">Call indexDocumentToRag after successful upload (don't await if non-blocking)</step>
    <step order="7">Run npm run build in PCF directory</step>
    <step order="8">Update TASK-INDEX.md: change task 050 status to âœ… completed</step>
  </steps>

  <tools>
    <tool name="npm">Build TypeScript/PCF projects</tool>
    <tool name="terminal">Run shell commands</tool>
  </tools>

  <outputs>
    <output type="code">src/client/pcf/ (upload control files)</output>
  </outputs>

  <acceptance-criteria>
    <criterion testable="true">indexDocumentToRag function exists</criterion>
    <criterion testable="true">Function calls /api/ai/rag/index-file endpoint</criterion>
    <criterion testable="true">Function is called after successful upload</criterion>
    <criterion testable="true">Errors are caught and logged, not thrown</criterion>
    <criterion testable="true">npm run build succeeds</criterion>
  </acceptance-criteria>

  <notes>
    Pattern for non-blocking RAG call:
    ```typescript
    // After successful upload
    indexDocumentToRag(driveId, itemId, tenantId).catch(err => {
      console.warn('RAG indexing failed:', err);
    });
    // Don't await - let it run in background
    ```
  </notes>

  <execution>
    <skill>.claude/skills/task-execute/SKILL.md</skill>
    <protocol>
      Before starting this task, load all files listed in knowledge/files.
      Follow the task-execute skill for mandatory pre-execution checklist.
    </protocol>
  </execution>
</task>
