<?xml version="1.0" encoding="UTF-8"?>
<task id="002" project="document-checkout-viewer">
  <metadata>
    <title>Add Checkout Fields to Document</title>
    <phase>1: Dataverse Schema</phase>
    <status>completed</status>
    <estimated-hours>2</estimated-hours>
    <dependencies>001</dependencies>
    <blocks>003</blocks>
    <tags>dataverse, solution, fields</tags>
  </metadata>

  <prompt>
    Add denormalized checkout status fields to the sprk_document entity for quick access
    to current checkout state. Also add a lookup to the current version and create a
    Version History subgrid on the Document form.
  </prompt>

  <role>
    SPAARKE platform developer. Expert in Dataverse entity customization and form design.
    Follow ADRs strictly.
  </role>

  <goal>
    The sprk_document entity has all checkout status fields added, a Version History
    subgrid displays on the Document form, and the current version lookup is configured.
  </goal>

  <context>
    <background>
      Denormalized fields on Document enable quick checkout status checks without joining
      to File Version table. This improves performance for the common case of checking
      if a document is locked.
    </background>
    <relevant-files>
      <file>projects/document-checkout-viewer/spec.md (Modified Entity: Document section)</file>
      <file>infrastructure/dataverse/ (existing Document entity)</file>
    </relevant-files>
  </context>

  <constraints>
    <constraint source="project">Fields must use sprk_ prefix per naming convention</constraint>
    <constraint source="project">Version History subgrid must show version number, dates, users</constraint>
  </constraints>

  <knowledge>
    <files>
      <file>.claude/skills/dataverse-deploy/SKILL.md</file>
      <file>infrastructure/dataverse/CLAUDE.md</file>
    </files>
    <patterns>
      <pattern name="Subgrid configuration" location="infrastructure/dataverse/">
        Follow existing subgrid patterns on forms
      </pattern>
    </patterns>
  </knowledge>

  <steps>
    <step order="1">Add sprk_currentversionid lookup field to sprk_fileversion</step>
    <step order="2">Add sprk_currentversionnumber (Whole Number) field</step>
    <step order="3">Add sprk_ischeckedout (Yes/No) field with default false</step>
    <step order="4">Add sprk_checkedoutby lookup to systemuser</step>
    <step order="5">Add sprk_checkedoutdate (DateTime) field</step>
    <step order="6">Open Document main form in form designer</step>
    <step order="7">Add Version History section with subgrid showing sprk_fileversion records</step>
    <step order="8">Configure subgrid columns: Version #, Checked Out By, Checked Out At, Checked In By, Checked In At, Comment, Status</step>
    <step order="9">Save and publish form changes</step>
    <step order="10">Update TASK-INDEX.md: change this task's status to completed</step>
  </steps>

  <tools>
    <tool name="pac">Power Platform CLI for solution operations</tool>
  </tools>

  <outputs>
    <output type="dataverse">Updated sprk_document entity with checkout fields</output>
    <output type="dataverse">Document form with Version History subgrid</output>
  </outputs>

  <acceptance-criteria>
    <criterion testable="true">All 5 checkout fields exist on sprk_document entity</criterion>
    <criterion testable="true">Version History subgrid displays on Document form</criterion>
    <criterion testable="true">Subgrid correctly shows related sprk_fileversion records</criterion>
  </acceptance-criteria>

  <notes>
    The subgrid should be sorted by version number descending (newest first).
    Consider adding the checkout status to the form header for visibility.
  </notes>

  <implementation-notes>
    <completed-date>2025-12-18</completed-date>
    <completed-by>Manual creation via Dataverse maker portal</completed-by>
    <actual-implementation>
      <form-changes>
        <change>Added History tab to Document form</change>
        <change>Added File Version subgrid on History tab</change>
      </form-changes>
      <fields-added>
        <field name="sprk_CurrentVersionId" type="lookup" target="sprk_fileversion"/>
        <field name="sprk_VersionNumber" type="text">Primary field mirrored from FileVersion</field>
        <field name="sprk_CheckInDate" type="datetime"/>
        <field name="sprk_CheckOutDate" type="datetime"/>
        <field name="sprk_CheckInBy" type="lookup" target="systemuser"/>
        <field name="sprk_CheckOutBy" type="lookup" target="systemuser"/>
        <field name="VersionNumber" type="integer">Numeric version counter</field>
      </fields-added>
    </actual-implementation>
    <deviations>
      Field naming slightly different from spec - sprk_VersionNumber is text, VersionNumber is integer.
      Added VersionNumber (integer) for auto-increment tracking by BFF.
    </deviations>
  </implementation-notes>

  <execution>
    <skill>.claude/skills/task-execute/SKILL.md</skill>
    <protocol>
      Before starting this task, load all files listed in knowledge/files.
      Follow the task-execute skill for mandatory pre-execution checklist.
    </protocol>
  </execution>
</task>
