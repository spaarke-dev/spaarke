<?xml version="1.0" encoding="UTF-8"?>
<task id="024" project="document-checkout-viewer">
  <metadata>
    <title>Implement Edit Mode with embedview</title>
    <phase>3: SpeDocumentViewer PCF</phase>
    <status>not-started</status>
    <estimated-hours>3</estimated-hours>
    <dependencies>023</dependencies>
    <blocks>025</blocks>
    <tags>pcf, react, typescript, frontend, fluent-ui</tags>
  </metadata>

  <prompt>
    Implement edit mode that displays the Office Online embedview iframe with full
    editing capabilities. Update toolbar to show Check In, Discard, and Open in Desktop
    buttons. Handle iframe loading and errors.
  </prompt>

  <role>
    SPAARKE platform developer. Expert in React and Office Online integration.
    Follow ADRs strictly.
  </role>

  <goal>
    Edit mode displays embedview with working Office Online editor, correct toolbar
    buttons, and proper handling of the edit URL from checkout response.
  </goal>

  <context>
    <background>
      Edit mode uses embedview URL which provides full Office Online functionality
      including comments and real-time co-authoring. The Share button is visible
      but acceptable during active editing.
    </background>
    <relevant-files>
      <file>projects/document-checkout-viewer/spec.md (Edit Mode section)</file>
      <file>src/client/pcf/SpeFileViewer/control/FilePreview.tsx (Office embed pattern)</file>
    </relevant-files>
  </context>

  <constraints>
    <constraint source="project">Use embedview URL from checkout response</constraint>
    <constraint source="project">Show Check In, Discard, Open in Desktop buttons</constraint>
    <constraint source="project">Show checkout status badge</constraint>
  </constraints>

  <knowledge>
    <files>
      <file>src/client/pcf/CLAUDE.md</file>
      <file>docs/ai-knowledge/guides/PCF-V9-PACKAGING.md</file>
      <file>.claude/skills/dataverse-deploy/SKILL.md</file>
    </files>
    <patterns>
      <pattern name="Office embed" location="src/client/pcf/SpeFileViewer/control/FilePreview.tsx">
        Follow iframe sandbox attributes for Office Online
      </pattern>
    </patterns>
  </knowledge>

  <steps>
    <step order="1">Update state to include editUrl from checkout response</step>
    <step order="2">Create edit mode view with embedview iframe</step>
    <step order="3">Update toolbar for edit mode: Check In, Discard, Open in Desktop</step>
    <step order="4">Implement Open in Desktop button using desktop URL from checkout</step>
    <step order="5">Show checkout status badge indicating current user has lock</step>
    <step order="6">Handle iframe loading state for edit mode</step>
    <step order="7">Add proper sandbox attributes for Office Online</step>
    <step order="8">Test edit mode with actual Office documents</step>
    <step order="9">Verify Comments feature works in embedview</step>
    <step order="10">Update TASK-INDEX.md: change this task's status to completed</step>
  </steps>

  <tools>
    <tool name="npm">Build TypeScript/PCF projects</tool>
  </tools>

  <outputs>
    <output type="code">src/client/pcf/SpeDocumentViewer/control/SpeDocumentViewer.tsx (modified)</output>
    <output type="code">src/client/pcf/SpeDocumentViewer/control/components/Toolbar.tsx (modified)</output>
  </outputs>

  <acceptance-criteria>
    <criterion testable="true">Edit mode displays embedview iframe</criterion>
    <criterion testable="true">Office Online editor loads with full functionality</criterion>
    <criterion testable="true">Check In and Discard buttons visible in edit mode</criterion>
    <criterion testable="true">Open in Desktop button launches desktop app</criterion>
    <criterion testable="true">Comments feature works within embedview</criterion>
  </acceptance-criteria>

  <notes>
    The embedview iframe needs specific sandbox attributes for Office Online to work.
    Test with .docx, .xlsx, and .pptx files.
  </notes>

  <execution>
    <skill>.claude/skills/task-execute/SKILL.md</skill>
    <protocol>
      Before starting this task, load all files listed in knowledge/files.
    </protocol>
  </execution>
</task>
