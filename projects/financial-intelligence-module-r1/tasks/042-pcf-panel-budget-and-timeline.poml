<?xml version="1.0" encoding="UTF-8"?>
<task id="042" project="financial-intelligence-module-r1">
  <metadata>
    <title>Implement Budget Gauge and Spend Timeline Components</title>
    <phase>4: PCF Panel + Integration + Polish</phase>
    <status>not-started</status>
    <estimated-hours>6</estimated-hours>
    <dependencies>041</dependencies>
    <blocks>043</blocks>
    <tags>pcf, react, typescript, frontend, fluent-ui</tags>
    <rigor-hint>FULL</rigor-hint>
    <rigor-reason>PCF tag triggers FULL protocol; creates .tsx files with visual components</rigor-reason>
    <parallel-group>none</parallel-group>
    <parallel-safe>false</parallel-safe>
  </metadata>

  <prompt>
    Implement two key visual components for the Finance Intelligence PCF panel: (1) BudgetGauge component — displays total budget, amount spent, remaining budget, and variance percentage as a visual gauge/progress indicator using Fluent v9 components (ProgressBar or custom SVG). Color-code by status: green (under 80%), yellow (80-100% warning), red (over 100% exceeded). Handle "no budget" state gracefully. (2) SpendTimeline component — displays monthly spend amounts over time as a bar chart or trend line using Fluent v9 primitives and semantic tokens. Show month labels on x-axis, amounts on y-axis. Handle empty data state. Both components consume data from the useFinanceSummary hook.
  </prompt>

  <role>
    SPAARKE frontend developer. Expert in React 16 component development, Fluent UI v9 data visualization, and accessible chart components. Familiar with semantic color tokens for theme-safe styling.
  </role>

  <goal>
    Two polished, theme-safe visual components (BudgetGauge and SpendTimeline) that display financial intelligence data in the PCF panel with proper loading, error, and empty states.
  </goal>

  <context>
    <background>
      The Finance Intelligence PCF panel (scaffolded in task 041) needs visual components to display budget and spend data. The BudgetGauge provides an at-a-glance view of budget utilization, while the SpendTimeline shows spending trends over time.

      Both components must use Fluent UI v9 exclusively with semantic tokens for all colors (no hard-coded values). This ensures proper rendering in light, dark, and high-contrast themes.

      The data comes from the useFinanceSummary hook which fetches from the finance summary endpoint (task 040).
    </background>
    <relevant-files>
      <file>src/client/pcf/FinanceIntelligencePanel/</file>
      <file>src/client/pcf/FinanceIntelligencePanel/hooks/useFinanceSummary.ts</file>
      <file>projects/financial-intelligence-module-r1/spec.md</file>
    </relevant-files>
  </context>

  <constraints>
    <constraint source="ADR-021">Fluent UI v9 exclusively — use semantic tokens for all colors</constraint>
    <constraint source="ADR-021">No hard-coded colors — use colorStatusSuccess, colorStatusWarning, colorStatusDanger tokens</constraint>
    <constraint source="ADR-021">Dark mode and high contrast support required</constraint>
    <constraint source="ADR-012">Import shared components from @spaarke/ui-components where available</constraint>
    <constraint source="spec">Budget status thresholds: green (under 80%), yellow (80-100%), red (over 100%)</constraint>
  </constraints>

  <knowledge>
    <files>
      <file path=".claude/constraints/pcf.md" reason="PCF control development constraints" />
      <file path=".claude/patterns/pcf/control-initialization.md" reason="PCF component patterns" />
      <file path=".claude/adr/ADR-021-fluent-ui-v9-design-system.md" reason="Fluent UI v9 design system and token usage" />
      <file path=".claude/adr/ADR-012-shared-component-library.md" reason="Shared component library" />
    </files>
    <patterns>
      <pattern name="Fluent UI v9 Theming" location=".claude/patterns/pcf/theme-management.md">
        Use Fluent v9 semantic tokens for all color values to ensure theme safety
      </pattern>
    </patterns>
  </knowledge>

  <steps>
    <step order="1">Read the FinanceIntelligencePanel scaffold from task 041 to understand the component structure and data hook</step>
    <step order="2">Read Fluent UI v9 ProgressBar and related components for budget gauge visualization options</step>
    <step order="3">Create components/BudgetGauge.tsx: display budget total, spent amount, remaining, variance percentage as a visual gauge</step>
    <step order="4">Implement BudgetGauge color coding using semantic tokens: colorStatusSuccess (under 80%), colorStatusWarning (80-100%), colorStatusDanger (over 100%)</step>
    <step order="5">Handle BudgetGauge "no budget" state: display "No budget configured" message when budgetTotal is null</step>
    <step order="6">Create components/SpendTimeline.tsx: display monthly spend amounts as a bar chart using Fluent v9 primitives</step>
    <step order="7">Implement SpendTimeline with month labels (x-axis) and amount values (y-axis), using semantic tokens for bar colors</step>
    <step order="8">Handle SpendTimeline empty state: display "No spend data available" when monthlySpendTrend is empty</step>
    <step order="9">Add loading states (Fluent Skeleton/Shimmer) for both components while data is being fetched</step>
    <step order="10">Wire both components into FinanceIntelligencePanel layout, consuming useFinanceSummary data</step>
    <step order="11">Build the control and verify no TypeScript compilation errors</step>
  </steps>

  <tools>
    <tool name="Read">Read existing components, patterns, and Fluent UI documentation</tool>
    <tool name="Write">Create BudgetGauge and SpendTimeline components</tool>
    <tool name="Edit">Wire components into FinanceIntelligencePanel layout</tool>
    <tool name="Bash">Build and verify compilation</tool>
  </tools>

  <outputs>
    <output type="code">src/client/pcf/FinanceIntelligencePanel/components/BudgetGauge.tsx</output>
    <output type="code">src/client/pcf/FinanceIntelligencePanel/components/SpendTimeline.tsx</output>
    <output type="code">Modified FinanceIntelligencePanel.tsx with BudgetGauge and SpendTimeline wired in</output>
  </outputs>

  <acceptance-criteria>
    <criterion testable="true">BudgetGauge displays budget total, spent amount, remaining amount, and variance percentage</criterion>
    <criterion testable="true">BudgetGauge uses semantic color tokens: colorStatusSuccess (under 80%), colorStatusWarning (80-100%), colorStatusDanger (over 100%)</criterion>
    <criterion testable="true">BudgetGauge displays "No budget configured" when budgetTotal is null</criterion>
    <criterion testable="true">SpendTimeline displays monthly spend amounts as bars/chart with month labels</criterion>
    <criterion testable="true">SpendTimeline displays "No spend data available" when monthlySpendTrend is empty</criterion>
    <criterion testable="true">Both components show loading skeleton/shimmer while data is fetching</criterion>
    <criterion testable="true">No hard-coded color values — all colors use Fluent v9 semantic tokens</criterion>
    <criterion testable="true">Components consume data from useFinanceSummary hook</criterion>
    <criterion testable="true">TypeScript compilation succeeds with no errors</criterion>
  </acceptance-criteria>

  <notes>
    For the SpendTimeline chart, consider using Fluent v9 primitives (divs with makeStyles) rather than a heavy charting library to keep bundle size down. Simple bar heights calculated as percentage of max value work well for a compact panel.

    The BudgetGauge can use Fluent ProgressBar with a custom color based on the utilization percentage, or a custom SVG gauge. ProgressBar is simpler and inherently accessible.

    All number formatting should use locale-aware formatting (Intl.NumberFormat) for currency amounts and percentages.
  </notes>

  <execution>
    <skill>.claude/skills/task-execute/SKILL.md</skill>
    <protocol>
      Before starting this task, load all files listed in knowledge/files.
      Follow the task-execute skill for mandatory pre-execution checklist.
      This is a FULL rigor task — all 11 protocol steps are mandatory.
    </protocol>
  </execution>
</task>
