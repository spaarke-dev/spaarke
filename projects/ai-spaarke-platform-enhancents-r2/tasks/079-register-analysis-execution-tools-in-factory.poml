<?xml version="1.0" encoding="UTF-8"?>
<task id="079" project="ai-spaarke-platform-enhancents-r2">
  <metadata>
    <title>Register AnalysisExecutionTools in SprkChatAgentFactory</title>
    <phase>2</phase>
    <package>Package E: Re-Analysis Pipeline</package>
    <tags>bff-api, ai</tags>
    <estimate>1-2 hours</estimate>
    <dependencies>078</dependencies>
    <parallel-group>sprint2-track2</parallel-group>
    <status>completed</status>
  </metadata>

  <prompt>
    <goal>
      Register AnalysisExecutionTools in SprkChatAgentFactory.ResolveTools(), gated behind the
      playbook capability "reanalyze". When a playbook declares the "reanalyze" capability,
      RerunAnalysisAsync and RefineAnalysisAsync become available to the AI agent.
    </goal>
    <context>
      SprkChatAgentFactory.ResolveTools() is the central integration point for adding tool classes
      to the AI agent. It reads the current playbook's capability declarations and conditionally
      includes tool classes. AnalysisExecutionTools should only be available when the playbook
      declares the "reanalyze" capability — this prevents re-analysis from appearing in lightweight
      playbooks (e.g., "Quick Q&A") where full document reprocessing is inappropriate.

      The registration follows the same pattern as existing tool registrations in the factory:
      check capability → instantiate via AIFunctionFactory.Create → add to tool list.
    </context>
    <constraints>
      - Follow ADR-010: No new DI registrations — factory instantiation only
      - Follow ADR-013: Tool registration via SprkChatAgentFactory.ResolveTools()
      - Gate behind "reanalyze" playbook capability
      - Follow existing tool registration pattern in SprkChatAgentFactory.cs
    </constraints>
  </prompt>

  <knowledge>
    <files>
      <file>.claude/adr/ADR-010-di-minimalism.md</file>
      <file>.claude/adr/ADR-013-ai-architecture.md</file>
      <file>.claude/constraints/ai.md</file>
    </files>
  </knowledge>

  <reference-implementations>
    <reference>src/server/api/Sprk.Bff.Api/Services/Ai/Chat/SprkChatAgentFactory.cs</reference>
    <reference>src/server/api/Sprk.Bff.Api/Services/Ai/Chat/Tools/AnalysisExecutionTools.cs</reference>
  </reference-implementations>

  <steps>
    <step order="1">
      Read SprkChatAgentFactory.cs to understand the existing tool registration pattern:
      - How ResolveTools() checks playbook capabilities
      - How tools are instantiated via AIFunctionFactory.Create
      - How tools are added to the tool list
    </step>
    <step order="2">
      Add AnalysisExecutionTools registration in ResolveTools():
      - Check if playbook capabilities include "reanalyze"
      - If yes, instantiate AnalysisExecutionTools via AIFunctionFactory.Create
      - Pass ChatHostContext and IAnalysisOrchestrationService to constructor
      - Add to tool list
    </step>
    <step order="3">
      Ensure the capability string "reanalyze" is defined as a constant (or follows existing
      convention for capability names in the codebase).
    </step>
    <step order="4">
      Build verification: Run dotnet build src/server/api/Sprk.Bff.Api/ to verify compilation.
    </step>
    <step order="5">
      Verify no new DI registrations: grep Program.cs and AiModule.cs to confirm.
    </step>
  </steps>

  <tools>
    <tool>Read - Examine SprkChatAgentFactory.cs registration pattern</tool>
    <tool>Edit - Add AnalysisExecutionTools registration</tool>
    <tool>Bash - dotnet build verification</tool>
  </tools>

  <relevant-files>
    <file action="modify">src/server/api/Sprk.Bff.Api/Services/Ai/Chat/SprkChatAgentFactory.cs</file>
    <file action="reference">src/server/api/Sprk.Bff.Api/Services/Ai/Chat/Tools/AnalysisExecutionTools.cs</file>
  </relevant-files>

  <placeholders>
    <!-- No placeholders — this task wires existing code -->
  </placeholders>

  <outputs>
    <output>Modified SprkChatAgentFactory.cs with AnalysisExecutionTools registration gated by "reanalyze" capability</output>
    <output>Successful dotnet build with 0 errors</output>
  </outputs>

  <acceptance-criteria>
    <criterion>SprkChatAgentFactory.ResolveTools() conditionally includes AnalysisExecutionTools</criterion>
    <criterion>AnalysisExecutionTools only included when playbook has "reanalyze" capability</criterion>
    <criterion>Tool instantiated via AIFunctionFactory.Create (not DI container)</criterion>
    <criterion>0 new DI registrations in Program.cs or AiModule.cs</criterion>
    <criterion>dotnet build src/server/api/Sprk.Bff.Api/ succeeds with zero errors</criterion>
  </acceptance-criteria>
</task>
