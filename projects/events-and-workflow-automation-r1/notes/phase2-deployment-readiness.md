# Phase 2 Deployment Readiness - Field Mapping Framework

> **Date**: 2026-02-01
> **Task**: 016 - Deploy Phase 2 - Field Mapping Framework
> **Status**: Build Verified - Ready for Deployment

---

## Deployment Readiness Checklist

| Item | Status | Details |
|------|--------|---------|
| FieldMappingAdmin PCF builds without errors | Passed | `npm run build` completed successfully |
| FieldMappingEndpoints.cs registered in Program.cs | Passed | Line 1366: `app.MapFieldMappingEndpoints();` |
| Type compatibility validation working (Task 015) | Passed | `TypeCompatibilityValidator.cs` implements Strict mode |
| DTOs defined | Passed | All required DTOs present |
| Version updated in PCF control | Passed | Version 1.1.0 in ControlManifest.Input.xml |
| BFF API builds without errors | Passed | `dotnet build` completed with 0 errors |

---

## Component Details

### FieldMappingAdmin PCF Control

**Location**: `src/client/pcf/FieldMappingAdmin/`

**Version**: 1.1.0

**Build Output**:
- Bundle size: 2,144,106 bytes (~2.1 MB)
- Files: `bundle.js`, `ControlManifest.xml`, `styles.css`

**Platform Libraries**:
- React: 16.14.0
- Fluent: 9.46.2

**Properties**:
- `profileId` (bound): GUID of the profile being edited
- `apiBaseUrl` (input): BFF API base URL (default: `https://spe-api-dev-67e2xz.azurewebsites.net/api`)

### BFF API Endpoints

**Location**: `src/server/api/Sprk.Bff.Api/Api/FieldMappings/`

**Endpoints**:

| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/v1/field-mappings/profiles` | List all field mapping profiles |
| GET | `/api/v1/field-mappings/profiles/{sourceEntity}/{targetEntity}` | Get profile by entity pair |
| POST | `/api/v1/field-mappings/validate` | Validate type compatibility |

**Registration**: `Program.cs` line 1366

### DTOs

| DTO | File | Purpose |
|-----|------|---------|
| `FieldMappingProfileDto` | `Models/FieldMapping/FieldMappingProfileDto.cs` | Profile summary |
| `FieldMappingRuleDto` | `Models/FieldMapping/FieldMappingRuleDto.cs` | Rule definition |
| `FieldMappingProfileWithRulesDto` | `Models/FieldMapping/FieldMappingProfileWithRulesDto.cs` | Profile with rules |
| `ValidateMappingRequest/Response` | `Api/FieldMappings/Dtos/` | Validation DTOs |

### Type Compatibility Validator

**Location**: `Api/FieldMappings/TypeCompatibilityValidator.cs`

**Strict Mode Compatibility Matrix**:
- Lookup -> [Lookup, Text]
- Text -> [Text, Memo]
- Memo -> [Text, Memo]
- OptionSet -> [OptionSet, Text]
- Number -> [Number, Text]
- DateTime -> [DateTime, Text]
- Boolean -> [Boolean, Text]

---

## Deployment Notes

### Deferred Deployment

Per Task 016 requirements, **actual deployment to Dataverse environment is deferred** until Task 036 (Deploy Phase 4 - Event Form Controls) when all PCF controls are ready.

### Pre-Deployment Requirements for Task 036

When ready to deploy:

1. **PCF Version Bumping** (4 locations):
   - [ ] `ControlManifest.Input.xml` (source) - currently 1.1.0
   - [ ] UI footer in component code (add version display)
   - [ ] `Solution.xml` (solution folder)
   - [ ] `ControlManifest.xml` (solution Controls folder)

2. **PCF Deployment**:
   - Use `pac pcf push --publisher-prefix sprk` for dev testing
   - Or full solution import for production releases

3. **API Deployment**:
   - Use `Deploy-BffApi.ps1` or `azure-deploy` skill
   - Target: `https://spe-api-dev-67e2xz.azurewebsites.net`

4. **Integration Testing**:
   - Verify PCF control renders on Field Mapping Profile form
   - Test API endpoints respond correctly
   - Verify PCF can call API endpoints

---

## Stub Status

The following stubs exist in the API (marked with `// STUB: [API]` comments):

| Stub ID | Location | Description |
|---------|----------|-------------|
| N/A | `FieldMappingEndpoints.cs` line 139 | `QueryFieldMappingProfilesAsync` returns empty array |
| S014-01 | `FieldMappingEndpoints.cs` line 294 | `QueryProfileWithRulesByEntityPairAsync` returns null |

These stubs will be resolved when:
- `sprk_fieldmappingprofile` entity is deployed (Task 001)
- Actual Dataverse queries are implemented

---

## Verification Commands

```bash
# Build PCF
cd src/client/pcf/FieldMappingAdmin
npm run build

# Build API
dotnet build src/server/api/Sprk.Bff.Api/

# Check PCF bundle size
ls -la src/client/pcf/FieldMappingAdmin/out/bundle.js

# Check API builds
dotnet build --no-restore src/server/api/Sprk.Bff.Api/
```

---

*Generated by task-execute for Task 016*
