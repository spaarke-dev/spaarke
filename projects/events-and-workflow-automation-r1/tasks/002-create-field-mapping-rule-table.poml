<?xml version="1.0" encoding="UTF-8"?>
<task id="002" project="events-and-workflow-automation-r1">
  <metadata>
    <title>Create Field Mapping Rule table</title>
    <phase>1: Foundation &amp; Data Model</phase>
    <status>not-started</status>
    <estimated-hours>2</estimated-hours>
    <dependencies>001</dependencies>
    <blocks>010, 050</blocks>
    <tags>dataverse, solution, fields</tags>
    <rigor-hint>STANDARD</rigor-hint>
    <rigor-reason>Task creates new Dataverse table with explicit constraints</rigor-reason>
    <parallel-group>none</parallel-group>
    <parallel-safe>false</parallel-safe>
  </metadata>

  <prompt>
    Create the Field Mapping Rule table (sprk_fieldmappingrule) in Dataverse. This table stores
    individual field-to-field mappings within a profile, defining how source fields map to target
    fields with type validation and transformation options.
  </prompt>

  <role>
    SPAARKE platform developer with expertise in Dataverse solution customization and table design.
    Follow ADRs strictly. Understand Power Platform schema conventions and relationship modeling.
  </role>

  <goal>
    Field Mapping Rule table created in Dataverse with all required fields including N:1 relationship
    to Field Mapping Profile. Table should support the type compatibility validation requirements.
  </goal>

  <context>
    <background>
      Field Mapping Rules are child records of Field Mapping Profiles. Each rule defines a single
      field-to-field mapping: which source field maps to which target field, the field types
      (for validation), and whether the mapping can be reversed (bidirectional).
    </background>
    <relevant-files>
      <file>projects/events-and-workflow-automation-r1/spec.md - Data Model section</file>
      <file>src/solutions/ - Existing Dataverse solutions</file>
    </relevant-files>
  </context>

  <constraints>
    <constraint source="spec">Table name: sprk_fieldmappingrule</constraint>
    <constraint source="spec">Must include: Profile (lookup), Source Field, Target Field, Source Type, Target Type, Is Reversible</constraint>
    <constraint source="spec">Field Type choice values: Lookup=0, Text=1, Memo=2, OptionSet=3, Number=4, DateTime=5, Boolean=6</constraint>
    <constraint source="project">N:1 relationship to sprk_fieldmappingprofile required</constraint>
  </constraints>

  <knowledge>
    <files>
      <file>.claude/constraints/plugins.md</file>
      <file>.claude/skills/dataverse-deploy/SKILL.md</file>
      <file>projects/events-and-workflow-automation-r1/spec.md</file>
    </files>
    <patterns>
      <pattern name="Dataverse Relationship" location=".claude/patterns/dataverse/">
        Standard pattern for N:1 relationships between Dataverse tables
      </pattern>
    </patterns>
  </knowledge>

  <steps>
    <step order="1">Review spec.md Data Model section for Field Mapping Rule table schema</step>
    <step order="2">Ensure task 001 is complete (Field Mapping Profile table exists)</step>
    <step order="3">Create sprk_fieldmappingrule table with display name "Field Mapping Rule"</step>
    <step order="4">Add Profile field (lookup to sprk_fieldmappingprofile, required)</step>
    <step order="5">Add Source Field field (text, max 100 chars, required) - logical name</step>
    <step order="6">Add Target Field field (text, max 100 chars, required) - logical name</step>
    <step order="7">Add Source Type field (choice: Lookup=0, Text=1, Memo=2, OptionSet=3, Number=4, DateTime=5, Boolean=6)</step>
    <step order="8">Add Target Type field (same choice options as Source Type)</step>
    <step order="9">Add Is Reversible field (boolean, default false)</step>
    <step order="10">Configure N:1 relationship with cascade delete from Profile</step>
    <step order="11">Add subgrid to Field Mapping Profile form showing related Rules</step>
    <step order="12">Add table to Spaarke solution</step>
    <step order="13">Export and verify solution XML</step>
    <step order="14">Update TASK-INDEX.md: change task 002 status to âœ… completed</step>
    <step order="15">Document any deviations in projects/events-and-workflow-automation-r1/notes/</step>
  </steps>

  <tools>
    <tool name="pac">Power Platform CLI for Dataverse operations</tool>
    <tool name="terminal">Run shell commands</tool>
  </tools>

  <outputs>
    <output type="dataverse">sprk_fieldmappingrule table in Dataverse</output>
    <output type="dataverse">N:1 relationship to sprk_fieldmappingprofile</output>
    <output type="solution">Updated Spaarke solution with new table and relationship</output>
  </outputs>

  <acceptance-criteria>
    <criterion testable="true">
      Given the Dataverse environment, when I navigate to Tables, then sprk_fieldmappingrule
      exists with all specified fields.
    </criterion>
    <criterion testable="true">
      Given a Field Mapping Profile record, when I view the form, then a subgrid shows related
      Field Mapping Rules.
    </criterion>
    <criterion testable="true">
      Given the Field Type choice fields, when I open the dropdown, then all 7 type options
      (Lookup through Boolean) are available.
    </criterion>
    <criterion testable="true">
      Given a Field Mapping Profile is deleted, when cascade delete executes, then all related
      Field Mapping Rules are also deleted.
    </criterion>
  </acceptance-criteria>

  <notes>
    Field types are stored as choices to enable UI dropdowns in the FieldMappingAdmin PCF.
    The actual type compatibility validation logic is implemented in FieldMappingService (task 011).

    Source Field and Target Field store logical field names (e.g., "sprk_clientname", "sprk_subject").
  </notes>

  <execution>
    <skill>.claude/skills/task-execute/SKILL.md</skill>
    <protocol>
      Before starting this task, load all files listed in knowledge/files section.
      Follow the task-execute skill for mandatory pre-execution checklist.
    </protocol>
  </execution>
</task>
