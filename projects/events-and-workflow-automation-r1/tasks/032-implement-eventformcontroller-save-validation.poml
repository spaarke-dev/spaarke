<?xml version="1.0" encoding="UTF-8"?>
<task id="032" project="events-and-workflow-automation-r1">
  <metadata>
    <title>Implement EventFormController - save validation</title>
    <phase>4: Event Form Controls</phase>
    <status>not-started</status>
    <estimated-hours>2</estimated-hours>
    <dependencies>031</dependencies>
    <blocks>035</blocks>
    <tags>pcf, react, typescript, frontend</tags>
    <rigor-hint>STANDARD</rigor-hint>
    <rigor-reason>Extends existing control with validation logic</rigor-reason>
    <parallel-group>none</parallel-group>
    <parallel-safe>false</parallel-safe>
  </metadata>

  <prompt>
    Implement save validation in EventFormController. When the user tries to save an Event,
    validate that all required fields (per Event Type configuration) are filled. Block save
    with clear error messages if validation fails.
  </prompt>

  <role>
    SPAARKE platform developer with expertise in PCF controls and Dataverse form validation.
  </role>

  <goal>
    EventFormController validates required fields on save. If required fields are empty, save
    is blocked and user sees which fields need to be filled.
  </goal>

  <context>
    <background>
      Without Business Rules, all validation must happen in code. EventFormController is
      responsible for ensuring Event Type-specific required fields are populated before save.
    </background>
    <relevant-files>
      <file>src/client/pcf/EventFormController/ - Control from tasks 030-031</file>
      <file>projects/events-and-workflow-automation-r1/spec.md - Validation requirements</file>
    </relevant-files>
  </context>

  <constraints>
    <constraint source="project">No Dataverse Business Rules - validation in PCF</constraint>
    <constraint source="spec">Block save if required fields are empty</constraint>
    <constraint source="spec">Show which fields need to be filled</constraint>
  </constraints>

  <knowledge>
    <files>
      <file>.claude/constraints/pcf.md</file>
      <file>src/client/pcf/CLAUDE.md</file>
    </files>
  </knowledge>

  <steps>
    <step order="1">Review spec.md validation requirements</step>
    <step order="2">Hook into form save event using context.mode.setControlState or similar</step>
    <step order="3">Implement validateRequiredFields() function</step>
    <step order="4">Check each required field (per Event Type config) has a value</step>
    <step order="5">If validation fails, prevent save using event.preventDefault() equivalent</step>
    <step order="6">Display validation errors using form notification or alert</step>
    <step order="7">Highlight invalid fields using setNotification on controls</step>
    <step order="8">Clear error indicators when fields are filled</step>
    <step order="9">Allow save when all required fields are populated</step>
    <step order="10">Build and verify validation works</step>
    <step order="11">Update TASK-INDEX.md: change task 032 status to âœ… completed</step>
  </steps>

  <tools>
    <tool name="npm">Build PCF control</tool>
    <tool name="pac">Power Platform CLI for testing</tool>
    <tool name="terminal">Run shell commands</tool>
  </tools>

  <outputs>
    <output type="code">src/client/pcf/EventFormController/EventFormController/handlers/SaveValidationHandler.ts</output>
  </outputs>

  <acceptance-criteria>
    <criterion testable="true">
      Given Event Type "Meeting" with empty Location field, when user clicks Save, then save
      is blocked and "Location is required" error is shown.
    </criterion>
    <criterion testable="true">
      Given all required fields are filled, when user clicks Save, then save proceeds normally.
    </criterion>
    <criterion testable="true">
      Given a validation error is shown, when user fills the field, then error indicator clears.
    </criterion>
  </acceptance-criteria>

  <notes>
    PCF controls can register for save events using:
    - Xrm.Page.data.entity.addOnSave(callback)
    - Return false or call executionContext.getEventArgs().preventDefault() to block save

    Alternative: Use form notification API:
    - Xrm.Page.ui.setFormNotification(message, "ERROR", "unique-id")
    - Xrm.Page.ui.clearFormNotification("unique-id")
  </notes>

  <execution>
    <skill>.claude/skills/task-execute/SKILL.md</skill>
    <protocol>
      Before starting this task, load all files listed in knowledge/files section.
      Follow the task-execute skill for mandatory pre-execution checklist.
    </protocol>
  </execution>
</task>
