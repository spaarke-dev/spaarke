<?xml version="1.0" encoding="UTF-8"?>
<task id="034" project="events-and-workflow-automation-r1">
  <metadata>
    <title>Build UpdateRelatedButton PCF control</title>
    <phase>4: Event Form Controls</phase>
    <status>completed</status>
    <estimated-hours>4</estimated-hours>
    <dependencies>005, 054</dependencies>
    <blocks>035</blocks>
    <tags>pcf, react, typescript, frontend, fluent-ui</tags>
    <rigor-hint>FULL</rigor-hint>
    <rigor-reason>Task tags include 'pcf', 'react' (code implementation)</rigor-reason>
    <parallel-group>none</parallel-group>
    <parallel-safe>false</parallel-safe>
  </metadata>

  <prompt>
    Build the UpdateRelatedButton PCF control for pushing field values from a parent record to
    all related child records. The control shows a button that triggers the push API, with
    confirmation dialog, progress indicator, and result toast.
  </prompt>

  <role>
    SPAARKE platform developer with expertise in PCF control development and async operations.
    Follow ADR-021 for Fluent UI v9. Follow ADR-022 for React 16 APIs.
  </role>

  <goal>
    UpdateRelatedButton PCF control implemented with: confirmation dialog before push, progress
    indicator during operation, and success/failure toast with counts of updated records.
  </goal>

  <context>
    <background>
      The "Update Related" sync mode allows pushing field values from a parent record down to
      all child records at once. This is useful when parent data changes and all related Events
      need to be synchronized. The push operation is handled by the BFF API (task 054).
    </background>
    <relevant-files>
      <file>src/client/pcf/UpdateRelatedButton/ - Control scaffold from task 005</file>
      <file>projects/events-and-workflow-automation-r1/spec.md - Update Related requirements</file>
    </relevant-files>
  </context>

  <constraints>
    <constraint source="ADR-021">Must use Fluent UI v9 Button, Dialog, Spinner, Toast</constraint>
    <constraint source="ADR-022">Must use React 16 APIs</constraint>
    <constraint source="spec">Must show confirmation before push</constraint>
    <constraint source="spec">Must show progress during operation</constraint>
    <constraint source="spec">Must show result count when complete</constraint>
  </constraints>

  <knowledge>
    <files>
      <file>.claude/constraints/pcf.md</file>
      <file>.claude/patterns/pcf/control-initialization.md</file>
      <file>.claude/patterns/pcf/theme-management.md</file>
      <file>src/client/pcf/CLAUDE.md</file>
      <file>docs/guides/PCF-V9-PACKAGING.md</file>
    </files>
  </knowledge>

  <steps>
    <step order="1">Review spec.md Update Related requirements</step>
    <step order="2">Open UpdateRelatedButton scaffold from task 005</step>
    <step order="3">Implement main Button component with "Update Related" label</step>
    <step order="4">Implement confirmation Dialog: "Update X Events with values from this {EntityType}?"</step>
    <step order="5">On confirmation, call POST /api/v1/field-mappings/push endpoint</step>
    <step order="6">Show Spinner/progress indicator during API call</step>
    <step order="7">Parse API response (updated count, failed count)</step>
    <step order="8">Show success Toast: "X Events updated successfully"</step>
    <step order="9">Show error Toast if operation fails</step>
    <step order="10">Handle edge cases (no children, API timeout, partial failure)</step>
    <step order="11">Add dark mode support</step>
    <step order="12">Build and verify control compiles</step>
    <step order="13">Update TASK-INDEX.md: change task 034 status to âœ… completed</step>
  </steps>

  <tools>
    <tool name="npm">Build PCF control</tool>
    <tool name="pac">Power Platform CLI for testing</tool>
    <tool name="terminal">Run shell commands</tool>
  </tools>

  <outputs>
    <output type="code">src/client/pcf/UpdateRelatedButton/UpdateRelatedButton/index.ts</output>
    <output type="code">src/client/pcf/UpdateRelatedButton/UpdateRelatedButton/components/UpdateRelatedDialog.tsx</output>
    <output type="code">src/client/pcf/UpdateRelatedButton/UpdateRelatedButton/components/PushResultToast.tsx</output>
  </outputs>

  <acceptance-criteria>
    <criterion testable="true">
      Given the UpdateRelatedButton on a Matter form, when clicked, then a confirmation dialog
      appears asking "Update related Events?"
    </criterion>
    <criterion testable="true">
      Given confirmation is accepted, when push API executes, then a spinner shows during the
      operation.
    </criterion>
    <criterion testable="true">
      Given push completes, when API returns, then a toast shows "X Events updated successfully".
    </criterion>
    <criterion testable="true">
      Given dark mode is active, when button and dialogs display, then colors use semantic tokens.
    </criterion>
    <criterion testable="true">Control builds without TypeScript errors.</criterion>
  </acceptance-criteria>

  <ui-tests>
    <test name="UpdateRelatedButton Confirmation">
      <url>https://{org}.crm.dynamics.com/main.aspx?appid={app-id}&amp;pagetype=entityrecord&amp;etn=sprk_matter</url>
      <steps>
        <step>Navigate to Matter form with related Events</step>
        <step>Click "Update Related" button</step>
        <step>Verify confirmation dialog appears</step>
        <step>Click Confirm</step>
        <step>Verify spinner appears during operation</step>
        <step>Verify success toast appears after completion</step>
      </steps>
      <expected>Full push workflow completes with feedback at each step</expected>
    </test>
    <test name="Dark Mode Compliance (ADR-021)">
      <steps>
        <step>Toggle dark mode in D365 settings</step>
        <step>Verify button, dialog, and toast colors adapt</step>
      </steps>
      <expected>All UI elements use semantic tokens per ADR-021</expected>
    </test>
  </ui-tests>

  <notes>
    This control depends on task 054 (Push API endpoint) being complete first.

    Push API request body:
    ```json
    {
      "sourceEntityType": "sprk_matter",
      "sourceRecordId": "guid-here",
      "targetEntityType": "sprk_event"
    }
    ```

    Push API response:
    ```json
    {
      "updatedCount": 15,
      "failedCount": 0,
      "errors": []
    }
    ```
  </notes>

  <execution>
    <skill>.claude/skills/task-execute/SKILL.md</skill>
    <protocol>
      Before starting this task, load all files listed in knowledge/files section.
      Follow the task-execute skill for mandatory pre-execution checklist.
    </protocol>
  </execution>
</task>
