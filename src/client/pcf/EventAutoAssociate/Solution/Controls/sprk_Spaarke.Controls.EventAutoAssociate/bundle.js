/*! For license information please see bundle.js.LICENSE.txt */
var pcf_tools_652ac3f36e1e4bca82eb3c1dc44e6fad;(()=>{"use strict";var e={d:(t,r)=>{for(var o in r)e.o(r,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:r[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{EventAutoAssociate:()=>u});var r=function(e,t,r,o){return new(r||(r=Promise))(function(n,a){function i(e){try{s(o.next(e))}catch(e){a(e)}}function c(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(i,c)}s((o=o.apply(e,t||[])).next())})},o="1.0.0",n=[{logicalName:"sprk_matter",displayName:"Matter",regardingField:"sprk_regardingmatter"},{logicalName:"sprk_project",displayName:"Project",regardingField:"sprk_regardingproject"},{logicalName:"sprk_invoice",displayName:"Invoice",regardingField:"sprk_regardinginvoice"},{logicalName:"sprk_analysis",displayName:"Analysis",regardingField:"sprk_regardinganalysis"},{logicalName:"account",displayName:"Account",regardingField:"sprk_regardingaccount"},{logicalName:"contact",displayName:"Contact",regardingField:"sprk_regardingcontact"},{logicalName:"sprk_workassignment",displayName:"Work Assignment",regardingField:"sprk_regardingworkassignment"},{logicalName:"sprk_budget",displayName:"Budget",regardingField:"sprk_regardingbudget"}],a="sprk_regardingrecordname",i="sprk_regardingrecordtype",c=null,s=new Map;function l(){var e;try{var t=window.Xrm||(null===(e=window.parent)||void 0===e?void 0:e.Xrm);return(null==t?void 0:t.Page)||null}catch(e){return console.warn("[EventAutoAssociate] Unable to access Xrm.Page:",e),null}}function d(){var e,t;try{var r=[window.location.href];try{(null===(t=null===(e=window.parent)||void 0===e?void 0:e.location)||void 0===t?void 0:t.href)&&r.push(window.parent.location.href)}catch(e){}for(var o of r){var n=new URL(o).searchParams.get("appid");if(n)return n.replace(/[{}]/g,"").toLowerCase()}}catch(e){}return""}function g(e,t){var r=l();if(!r)return!1;try{var o=r.getAttribute(e);if(o)return o.setValue(t),console.log("[EventAutoAssociate] Set ".concat(e,' to "').concat(t,'"')),!0}catch(t){console.error("[EventAutoAssociate] Error setting ".concat(e,":"),t)}return!1}class u{constructor(){this.container=null,this.context=null,this.hasRun=!1}init(e,t,r,n){this.context=e,this.container=n,n.innerHTML='<div style="display:none" data-control="EventAutoAssociate" data-version="'.concat(o,'"></div>'),console.log("[EventAutoAssociate] v".concat(o," initialized")),this.runAutoDetection()}runAutoDetection(){return r(this,void 0,void 0,function*(){if(this.hasRun)console.log("[EventAutoAssociate] Already ran, skipping");else if(this.hasRun=!0,this.context){var e=this.context.webAPI;if(yield new Promise(e=>setTimeout(e,100)),function(){var e=l();if(!e)return!1;try{var t=e.getAttribute(a),r=e.getAttribute(i);if(t){var o=t.getValue();if(o&&"string"==typeof o&&o.trim().length>0)return console.log("[EventAutoAssociate] Denormalized fields already populated"),!0}if(r){var n=r.getValue();if(n&&Array.isArray(n)&&n.length>0)return console.log("[EventAutoAssociate] Denormalized fields already populated (type lookup set)"),!0}}catch(e){console.warn("[EventAutoAssociate] Error checking denormalized fields:",e)}return!1}())console.log("[EventAutoAssociate] Denormalized fields already set, no action needed");else{yield function(e){return r(this,void 0,void 0,function*(){if(c)return c;try{console.log("[EventAutoAssociate] Loading entity configs from sprk_recordtype_ref...");var t=yield e.retrieveMultipleRecords("sprk_recordtype_ref","?$filter=statecode eq 0&$select=sprk_recordtype_refid,sprk_recordlogicalname,sprk_recorddisplayname,sprk_regardingfield&$orderby=sprk_recorddisplayname");if(t.entities&&t.entities.length>0)return c=t.entities.filter(e=>e.sprk_recordlogicalname&&e.sprk_regardingfield).map(e=>({logicalName:e.sprk_recordlogicalname,displayName:e.sprk_recorddisplayname||e.sprk_recordlogicalname,regardingField:e.sprk_regardingfield})),console.log("[EventAutoAssociate] Loaded ".concat(c.length," entity configs")),c}catch(e){console.warn("[EventAutoAssociate] Error loading entity configs, using fallback:",e)}return c=[...n]})}(e);var t=function(){var e=l();if(!e)return console.log("[EventAutoAssociate] Xrm.Page not available for parent detection"),null;for(var t of(console.log("[EventAutoAssociate] Checking for pre-populated regarding fields..."),c||n))try{var r=e.getAttribute(t.regardingField);if(r){var o=r.getValue();if(o&&Array.isArray(o)&&o.length>0){var a=o[0];if(a&&a.id){var i={entityType:t.logicalName,entityDisplayName:t.displayName,recordId:a.id.replace(/[{}]/g,""),recordName:a.name||"",regardingField:t.regardingField};return console.log("[EventAutoAssociate] Detected parent: ".concat(t.displayName," - ").concat(i.recordName)),i}}}}catch(e){console.warn("[EventAutoAssociate] Error checking ".concat(t.regardingField,":"),e)}return console.log("[EventAutoAssociate] No pre-populated regarding field detected"),null}();t?yield function(e,t){return r(this,void 0,void 0,function*(){console.log("[EventAutoAssociate] Completing association for: ".concat(e.entityDisplayName," - ").concat(e.recordName));var o=!0;g(a,e.recordName)||(o=!1),g("sprk_regardingrecordid",e.recordId)||(o=!1),g("sprk_regardingrecordurl",function(e,t){var r,o,n,a=t.replace(/[{}]/g,"").toLowerCase();try{var i=window.Xrm||(null===(r=window.parent)||void 0===r?void 0:r.Xrm);if(null===(o=null==i?void 0:i.Utility)||void 0===o?void 0:o.getGlobalContext){var c=i.Utility.getGlobalContext(),s=(null===(n=c.getClientUrl)||void 0===n?void 0:n.call(c))||"",l="";if(c.getCurrentAppId){var g=c.getCurrentAppId();l="string"==typeof g?g:d()}if(l||(l=d()),s){var u=new URL("/main.aspx",s);return l&&u.searchParams.set("appid",l.replace(/[{}]/g,"").toLowerCase()),u.searchParams.set("pagetype","entityrecord"),u.searchParams.set("etn",e),u.searchParams.set("id",a),u.toString()}}}catch(e){console.warn("[EventAutoAssociate] Error building record URL, using fallback:",e)}return"/main.aspx?pagetype=entityrecord&etn=".concat(e,"&id=").concat(a)}(e.entityType,e.recordId))||(o=!1);var n=yield function(e,t){return r(this,void 0,void 0,function*(){var r=s.get(t);if(r)return r;try{var o="?$filter=sprk_recordlogicalname eq '".concat(t,"' and statecode eq 0&$select=sprk_recordtype_refid,sprk_recorddisplayname"),n=yield e.retrieveMultipleRecords("sprk_recordtype_ref",o);if(n.entities&&n.entities.length>0){var a=n.entities[0],i=a.sprk_recordtype_refid,c=a.sprk_recorddisplayname;return s.set(t,{id:i,name:c}),console.log("[EventAutoAssociate] Found Record Type for ".concat(t,": ").concat(c)),{id:i,name:c}}}catch(e){console.error("[EventAutoAssociate] Error querying Record Type for ".concat(t,":"),e)}return null})}(t,e.entityType);return n?function(e,t,r,o){var n=l();if(!n)return!1;try{var a=n.getAttribute(e);if(a){var i=r.replace(/[{}]/g,"");return a.setValue([{id:i,name:o,entityType:"sprk_recordtype_ref"}]),console.log("[EventAutoAssociate] Set ".concat(e," to ").concat(o)),!0}}catch(t){console.error("[EventAutoAssociate] Error setting ".concat(e,":"),t)}return!1}(i,0,n.id,n.name)||(o=!1):(console.warn("[EventAutoAssociate] Record Type not found for entity: ".concat(e.entityType)),o=!1),console.log("[EventAutoAssociate] Association completed: success=".concat(o)),o})}(t,e):console.log("[EventAutoAssociate] No parent detected, no action needed")}}else console.warn("[EventAutoAssociate] Context not available")})}updateView(e){this.context=e}getOutputs(){return{}}destroy(){this.container&&(this.container.innerHTML="",this.container=null),this.context=null}}pcf_tools_652ac3f36e1e4bca82eb3c1dc44e6fad=t})();
if (window.ComponentFramework && window.ComponentFramework.registerControl) {
	ComponentFramework.registerControl('Spaarke.Controls.EventAutoAssociate', pcf_tools_652ac3f36e1e4bca82eb3c1dc44e6fad.EventAutoAssociate);
} else {
	var Spaarke = Spaarke || {};
	Spaarke.Controls = Spaarke.Controls || {};
	Spaarke.Controls.EventAutoAssociate = pcf_tools_652ac3f36e1e4bca82eb3c1dc44e6fad.EventAutoAssociate;
	pcf_tools_652ac3f36e1e4bca82eb3c1dc44e6fad = undefined;
}